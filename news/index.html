<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIBDash - Defense Industrial Base Intelligence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible+Next:ital,wght@0,200..800;1,200..800&display=swap" rel="stylesheet">
    <style>
:root {
    /* E-ink inspired color palette with green/grey tints */
    --bg-primary: #f4f6f3;
    --bg-secondary: #eef2ed;
    --bg-tertiary: #e8ede6;
    --surface: #f8faf7;
    --border-light: #e2e7e0;
    --border-medium: #d4dbd2;
    --text-primary: #2a3028;
    --text-secondary: #4a524a;
    --text-tertiary: #6b736b;
    --text-quaternary: #8b938b;
    --accent-subtle: #3d4f3d;
    --accent-muted: #5a6e5a;
    --shadow-soft: rgba(45, 55, 45, 0.03);
    --shadow-medium: rgba(45, 55, 45, 0.06);
    --category-defense: #4a6b4a;
    --category-industry: #5a5e6b;
    --category-government: #6b5a3d;
    --fresh-accent: #4a7c59;
    --breaking-accent: #7c4a4a;
    
    /* E-ink specific additions */
    --ink-green: #3d4f3d;
    --ink-grey: #5a625a;
    --paper-white: #f9fbf8;
    --paper-cream: #f6f8f5;
    
    /* AI Intelligence colors */
    --intelligence-bg: #f0f4f8;
    --intelligence-border: #b8c5d1;
    --threat-low: #4a7c59;
    --threat-moderate: #7c7c4a;
    --threat-elevated: #7c6b4a;
    --threat-high: #7c4a4a;
}

body.dark-mode {
    --bg-primary: #1e211e;
    --bg-secondary: #252925;
    --bg-tertiary: #2c302c;
    --surface: #222622;
    --border-light: #3a403a;
    --border-medium: #4c524c;
    --text-primary: #e0e5e0;
    --text-secondary: #b0b5b0;
    --text-tertiary: #808580;
    --text-quaternary: #606560;
    --accent-subtle: #6a806a;
    --accent-muted: #8ab08a;
    --shadow-soft: rgba(0, 0, 0, 0.1);
    --shadow-medium: rgba(0, 0, 0, 0.2);
    --category-defense: #72a672;
    --category-industry: #8a8fb0;
    --category-government: #b08a6b;
    --fresh-accent: #72a683;
    --breaking-accent: #b07a7a;
    --intelligence-bg: #2a2f35;
    --intelligence-border: #4a5a6a;
    --ink-green: #6a806a;
    --ink-grey: #8a8e8a;
    --paper-white: #202420;
    --paper-cream: #282c28;
}

/* Evening mode with warmer e-ink tones */
body.evening-mode {
    --bg-primary: #f2f4f1;
    --bg-secondary: #ece8e5;
    --surface: #f6f3f0;
    --text-primary: #2d332d;
    --ink-green: #3a4a3a;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Atkinson Hyperlegible Next', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.4;
    font-size: 13px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    letter-spacing: -0.005em;
    transition: background-color 0.3s ease;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 10px;
}

/* Header with contextual messaging */
header {
    padding: 10px 0 6px 0;
    border-bottom: 1px solid var(--border-light);
    margin-bottom: 8px;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-left {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 1px;
}

.greeting {
    font-size: 8px;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: 400;
    display: flex;
    align-items: center;
    gap: 5px;
}

.weekend-emoji {
    font-size: 10px;
}

h1 {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
    letter-spacing: -0.01em;
}

.current-date {
    font-size: 8px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 400;
    margin-top: 1px;
    margin-bottom: 1px;
}

.last-updated {
    font-size: 8px;
    color: var(--text-quaternary);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 400;
    margin-top: 1px;
}

.contextual-message {
    font-size: 9px;
    color: var(--accent-muted);
    font-style: italic;
    margin-top: 2px;
}

.header-right {
    display: flex;
    gap: 6px;
    align-items: center;
}

.action-btn {
    background: none;
    border: 1px solid var(--border-medium);
    color: var(--text-tertiary);
    padding: 4px 8px;
    border-radius: 12px;
    cursor: pointer;
    font-family: inherit;
    font-size: 9px;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
}

.action-btn:hover {
    background: var(--bg-secondary);
    border-color: var(--border-medium);
    color: var(--text-secondary);
}

.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.action-btn.active {
    background: var(--text-primary);
    border-color: var(--text-primary);
    color: var(--bg-primary);
}

.refresh-btn.loading svg {
    animation: gentleSpin 2s linear infinite;
}

/* ü§ñ AI Intelligence Section */
.intelligence-section {
    background: var(--intelligence-bg);
    border: 1px solid var(--intelligence-border);
    border-radius: 12px;
    margin-bottom: 20px;
    padding: 16px;
    box-shadow: var(--shadow-medium);
}

.intelligence-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
}

.intelligence-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.intelligence-title .icon {
    font-size: 16px;
}

.threat-indicator {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 8px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.threat-low { background: var(--threat-low); color: white; }
.threat-moderate { background: var(--threat-moderate); color: white; }
.threat-elevated { background: var(--threat-elevated); color: white; }
.threat-high { background: var(--threat-high); color: white; }

.intelligence-summary {
    font-size: 11px;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: 16px;
    padding: 12px;
    background: var(--surface);
    border-radius: 8px;
    border-left: 4px solid var(--accent-muted);
}

.intelligence-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
}

.intelligence-card {
    background: var(--surface);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    padding: 12px;
}

.intelligence-card h3 {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--accent-subtle);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.intelligence-card ul {
    list-style: none;
    padding: 0;
}

.intelligence-card li {
    font-size: 10px;
    color: var(--text-secondary);
    margin-bottom: 4px;
    padding-left: 12px;
    position: relative;
}

.intelligence-card li::before {
    content: "‚Ä¢";
    color: var(--accent-muted);
    position: absolute;
    left: 0;
}

.key-developments {
    grid-column: 1 / -1;
}

.development-item {
    background: var(--bg-secondary);
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 8px;
    border-left: 3px solid var(--accent-muted);
}

.development-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.development-category {
    font-size: 8px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--accent-subtle);
    font-weight: 600;
}

.development-urgency {
    font-size: 7px;
    padding: 2px 6px;
    border-radius: 8px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.urgency-high {
    background: var(--threat-high);
    color: white;
}

.urgency-medium {
    background: var(--threat-moderate);
    color: white;
}

.urgency-low {
    background: var(--threat-low);
    color: white;
}

.development-headline {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.development-significance {
    font-size: 10px;
    color: var(--text-secondary);
    line-height: 1.4;
}

.opportunity-score {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
    padding: 8px;
    background: var(--bg-secondary);
    border-radius: 6px;
}

.score-label {
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-tertiary);
}

.score-value {
    font-size: 14px;
    font-weight: 700;
    color: var(--accent-subtle);
}

.score-bar {
    flex: 1;
    height: 4px;
    background: var(--border-light);
    border-radius: 2px;
    overflow: hidden;
}

.score-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--threat-low), var(--threat-moderate), var(--threat-elevated));
    transition: width 0.5s ease;
}

/* Toggle for intelligence section */
.intelligence-toggle {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 12px;
    color: var(--text-tertiary);
    padding: 4px;
}

.intelligence-toggle:hover {
    color: var(--text-primary);
}

.intelligence-content.collapsed {
    display: none;
}

/* Category filters */
.filters {
    display: flex;
    gap: 6px;
    margin-bottom: 12px;
    flex-wrap: wrap;
    align-items: center;
}

.filter-tab {
    background: none;
    border: 1px solid var(--border-medium);
    color: var(--text-tertiary);
    padding: 4px 10px;
    border-radius: 16px;
    cursor: pointer;
    font-family: inherit;
    font-size: 9px;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.filter-tab:hover {
    background: var(--bg-secondary);
    border-color: var(--border-medium);
    color: var(--text-secondary);
}

.filter-tab.active {
    background: var(--text-primary);
    border-color: var(--text-primary);
    color: var(--bg-primary);
}

.filter-tab.defense.active {
    background: var(--category-defense);
    border-color: var(--category-defense);
}

.filter-tab.industry.active {
    background: var(--category-industry);
    border-color: var(--category-industry);
}

.filter-tab.government.active {
    background: var(--category-government);
    border-color: var(--category-government);
}

.fresh-count {
    font-size: 8px;
    background: var(--fresh-accent);
    color: white;
    padding: 1px 4px;
    border-radius: 8px;
    margin-left: 4px;
}

/* Date group headers */
.date-group {
    margin-bottom: 16px;
}

.date-group-header {
    font-size: 10px;
    font-weight: 500;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 8px;
    padding-left: 2px;
    border-bottom: 1px solid var(--border-light);
    padding-bottom: 4px;
}

/* Article grid */
.article-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 6px;
    transition: gap 0.3s ease;
}

body .article-grid {
    gap: 6px;
}

.article {
    background: var(--surface);
    padding: 12px;
    transition: all 0.3s ease;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    box-shadow: var(--shadow-soft);
    display: flex;
    flex-direction: column;
    height: fit-content;
    position: relative;
}

.article:hover {
    box-shadow: var(--shadow-medium);
    transform: translateY(-1px);
    border-color: var(--border-medium);
}

.article.fresh {
}

.article.focused {
    opacity: 1 !important;
}

body.focus-mode .article:not(.focused) {
    opacity: 0.4;
}

.article-meta {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-bottom: 6px;
    font-size: 8px;
    color: var(--text-quaternary);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 400;
}

.article-source {
    color: var(--accent-muted);
    font-weight: 500;
}

.article-source.defense { color: var(--category-defense); }
.article-source.industry { color: var(--category-industry); }
.article-source.government { color: var(--category-government); }

.article-separator {
    width: 2px;
    height: 2px;
    background: var(--text-quaternary);
    border-radius: 50%;
}

.article-time {
    color: var(--text-quaternary);
}

.article-hints {
    display: flex;
    gap: 3px;
    margin-left: auto;
    font-size: 10px;
}

.hint-emoji {
    opacity: 0.6;
}

.reading-time {
    font-size: 7px;
    color: var(--text-quaternary);
    margin-left: auto;
}

.article-title {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-primary);
    line-height: 1.3;
    margin-bottom: 5px;
    letter-spacing: -0.01em;
}

.article-description {
    font-size: 11px;
    color: var(--text-secondary);
    line-height: 1.4;
    font-weight: 300;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    flex-grow: 1;
}

.article-actions {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid var(--border-light);
}

.article-action-button {
    background: var(--surface);
    border: 1px solid var(--border-medium);
    color: var(--text-secondary);
    padding: 6px 12px;
    border-radius: 20px;
    cursor: pointer;
    font-family: inherit;
    font-size: 10px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: all 0.2s ease;
    white-space: nowrap;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.article-action-button:hover {
    background: var(--bg-secondary);
    border-color: var(--accent-muted);
}

/* All the remaining styles from your original CSS... */
/* Contract Awards Section */
.contracts-section {
    margin-bottom: 20px;
    padding: 12px 0;
    border-bottom: 2px solid var(--border-light);
}

.contracts-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
}

.contracts-title {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 6px;
}

.contracts-badge {
    background: var(--accent-subtle);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 9px;
    font-weight: 500;
}

.contracts-summary {
    font-size: 10px;
    color: var(--text-tertiary);
}

.contracts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 8px;
    margin-bottom: 10px;
}

.agency-card {
    background: var(--surface);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.agency-card:hover {
    box-shadow: 0 2px 8px var(--shadow-medium);
    transform: translateY(-1px);
    border-color: var(--border-medium);
}

.agency-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
}

.agency-name {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--accent-subtle);
    display: flex;
    align-items: center;
    gap: 4px;
}

.agency-icon {
    font-size: 14px;
}

.agency-total {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
}

.agency-stats {
    display: flex;
    gap: 12px;
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid var(--border-light);
}

.stat-item {
    display: flex;
    flex-direction: column;
}

.stat-label {
    font-size: 8px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-quaternary);
}

.stat-value {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-secondary);
}

.top-contracts {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border-light);
}

.contract-item {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin: 4px 0;
    font-size: 10px;
    color: var(--text-secondary);
}

.contract-company {
    flex: 1;
    font-weight: 500;
    color: var(--text-primary);
    margin-right: 8px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.contract-value {
    font-weight: 600;
    color: var(--accent-subtle);
    white-space: nowrap;
}

.contract-type-badge {
    display: inline-block;
    font-size: 7px;
    padding: 2px 4px;
    border-radius: 4px;
    background: var(--bg-tertiary);
    color: var(--text-tertiary);
    margin-left: 4px;
    text-transform: uppercase;
}

/* Contract details modal */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-overlay.active {
    display: flex;
}

.modal-content {
    background: var(--surface);
    border-radius: 12px;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 20px;
    margin: 20px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.modal-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--text-tertiary);
}

.contracts-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.contract-detail {
    padding: 10px;
    background: var(--bg-secondary);
    border-radius: 6px;
    font-size: 11px;
}

.contract-detail-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
}

.contract-detail-company {
    font-weight: 600;
    color: var(--text-primary);
}

.contract-detail-value {
    font-weight: 600;
    color: var(--accent-subtle);
}

.contract-detail-info {
    color: var(--text-secondary);
    line-height: 1.4;
}

/* Stock Ticker specific styling */
.stock-ticker-section {
    margin-bottom: 20px;
    background: var(--surface);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    box-shadow: var(--shadow-soft);
    padding: 8px 12px;
    overflow: hidden;
    position: relative;
}

.stock-ticker-header {
    font-size: 8px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-tertiary);
    margin-bottom: 8px;
}

.ticker-scroll-wrapper {
    position: relative;
    white-space: nowrap;
    overflow: hidden;
}

.ticker-scroll-content {
    display: inline-block;
    animation: tickerScroll 120s linear infinite;
    will-change: transform;
}

.stock-item {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 0 16px;
}

.stock-ticker {
    font-size: 10px;
    font-weight: 600;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.stock-price {
    font-size: 10px;
    color: var(--text-secondary);
}

.stock-percent-change {
    font-size: 9px;
    font-weight: 500;
    margin-left: -4px;
}

.stock-change-positive {
    color: #28a745;
}

.stock-change-negative {
    color: #dc3545;
}

@keyframes tickerScroll {
    from { transform: translateX(0%); }
    to { transform: translateX(-50%); }
}

/* Rest of the existing styles... */
.keyboard-help {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--surface);
    border: 1px solid var(--border-medium);
    border-radius: 8px;
    padding: 10px;
    box-shadow: 0 2px 8px var(--shadow-medium);
    font-size: 10px;
    display: none;
    z-index: 1000;
}

.keyboard-help.visible {
    display: block;
}

.keyboard-help h3 {
    font-size: 11px;
    margin-bottom: 6px;
    color: var(--text-primary);
}

.keyboard-help .shortcut {
    display: flex;
    justify-content: space-between;
    margin: 3px 0;
    color: var(--text-secondary);
}

.keyboard-help kbd {
    background: var(--bg-tertiary);
    padding: 2px 4px;
    border-radius: 3px;
    font-family: monospace;
    font-size: 9px;
}

/* Footer */
footer {
    margin-top: 40px;
    border-top: 1px solid var(--border-light);
    padding: 20px 0;
    background: var(--bg-secondary);
}

.footer-content {
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: center;
    text-align: center;
}

.footer-about p {
    font-size: 11px;
    color: var(--text-secondary);
    line-height: 1.4;
    font-weight: 300;
    max-width: 500px;
    margin: 0 auto;
}

.share-link {
    font-size: 10px;
    color: var(--accent-muted);
    text-decoration: none;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 400;
    padding: 6px 12px;
    border: 1px solid var(--border-medium);
    border-radius: 16px;
    transition: all 0.2s ease;
    background: var(--surface);
}

.share-link:hover {
    background: var(--bg-tertiary);
    border-color: var(--accent-muted);
    color: var(--text-primary);
    transform: translateY(-1px);
}

.footer-copyright p {
    font-size: 9px;
    color: var(--text-quaternary);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 400;
}

/* Desktop 4-column grid */
@media (min-width: 1200px) {
    .article-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .intelligence-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (min-width: 900px) and (max-width: 1199px) {
    .article-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (min-width: 600px) and (max-width: 899px) {
    .article-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .intelligence-grid {
        grid-template-columns: 1fr;
    }
}

/* Mobile */
@media (max-width: 599px) {
    .container {
        padding: 0 10px;
    }
    
    header {
        padding: 8px 0 6px 0;
        margin-bottom: 6px;
    }
    
    .header-content {
        flex-direction: column;
        gap: 4px;
        align-items: flex-start;
    }
    
    .header-left {
        gap: 0px;
    }
    
    .greeting, .current-date, .last-updated {
        font-size: 7px;
    }
    
    h1 {
        font-size: 14px;
    }
    
    .filters {
        gap: 4px;
        margin-bottom: 10px;
        margin-left: 0;
    }
    
    .filter-tab {
        padding: 4px 10px;
        font-size: 9px;
    }
    
    .article-grid {
        grid-template-columns: 1fr;
        gap: 8px;
    }
    
    .article {
        padding: 12px;
    }
    
    .article-title {
        font-size: 12px;
        margin-bottom: 3px;
    }
    
    .article-description {
        font-size: 10px;
        line-height: 1.3;
        -webkit-line-clamp: 3;
    }
    
    .article-meta {
       margin-bottom: 4px;
   }
   
   .intelligence-section {
       padding: 12px;
   }
   
   .intelligence-grid {
       grid-template-columns: 1fr;
       gap: 12px;
   }
   
   .contracts-grid {
       grid-template-columns: 1fr;
   }
   
   footer {
       margin-top: 30px;
       padding: 16px 0;
   }
   
   .footer-content {
       gap: 10px;
   }
   
   .footer-about p {
       font-size: 10px;
       line-height: 1.3;
   }
   
   .share-link {
       font-size: 9px;
       padding: 5px 10px;
   }
   
   .footer-copyright p {
       font-size: 8px;
   }
}

/* States */
.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 30px 10px;
    color: var(--text-tertiary);
}

.empty-state .icon {
    font-size: 24px;
    margin-bottom: 10px;
    opacity: 0.3;
}

.empty-state h3 {
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 5px;
    color: var(--text-secondary);
}

.empty-state p {
    font-size: 10px;
    color: var(--text-tertiary);
    font-weight: 300;
    line-height: 1.3;
}

.loading {
    grid-column: 1 / -1;
    text-align: center;
    padding: 15px;
    color: var(--text-tertiary);
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: 400;
}

.loading-message {
    animation: fadeInOut 2s ease infinite;
}

@keyframes fadeInOut {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}

.error-message {
    background: #fef9f9;
    border: 1px solid #f5e6e6;
    color: var(--text-secondary);
    padding: 6px 10px;
    border-radius: 4px;
    margin-bottom: 8px;
    font-size: 10px;
    display: none;
    text-align: center;
    font-weight: 300;
}

/* Progress indicator */
.reading-progress {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 1px;
    background: var(--border-light);
    z-index: 100;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-subtle), var(--accent-muted));
    width: 0%;
    transition: width 0.1s ease;
}

/* Smooth scroll */
html {
    scroll-behavior: smooth;
}

/* Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(3px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.article {
    animation: fadeIn 0.2s ease forwards;
}

.article:nth-child(1) { animation-delay: 0.02s; }
.article:nth-child(2) { animation-delay: 0.04s; }
.article:nth-child(3) { animation-delay: 0.06s; }
.article:nth-child(4) { animation-delay: 0.08s; }

@keyframes gentleSpin {
    to { transform: rotate(360deg); }
}

/* Focus states */
.refresh-btn:focus,
.filter-tab:focus,
.article:focus,
.share-link:focus {
    outline: 2px solid var(--accent-muted);
    outline-offset: 2px;
}

/* Toast notification */
.toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--surface);
    border: 1px solid var(--border-medium);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 10px;
    color: var(--text-primary);
    box-shadow: 0 2px 8px var(--shadow-medium);
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 1001;
}

.toast.visible {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

/* Pull to refresh indicator (mobile) */
.pull-to-refresh {
    position: fixed;
    top: -50px;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 40px;
    background: var(--surface);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px var(--shadow-medium);
    transition: top 0.3s ease;
    z-index: 99;
}

.pull-to-refresh.refreshing {
    animation: gentleSpin 1s linear infinite;
}

/* Ad Placement CSS */
.ad-placeholder {
    background: var(--surface);
    border: 1px dashed var(--border-medium);
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 16px;
    text-align: center;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-soft);
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.ad-placeholder:hover {
    background: var(--bg-tertiary);
}

.ad-content {
    color: var(--text-secondary);
    font-weight: 500;
    text-transform: none;
    letter-spacing: normal;
    font-size: 14px;
    line-height: 1.4;
}

.ad-label {
    font-size: 9px;
    color: var(--text-quaternary);
    margin-top: 8px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}
    </style>
</head>
<body>
   <div class="reading-progress">
       <div class="progress-bar" id="progressBar"></div>
   </div>
   
   <div class="container">
       <header>
           <div class="header-content">
               <div class="header-left">
                   <h1>ü§ñ DIBDash - Defense Industrial Base Intelligence</h1>
                   <div class="current-date" id="currentDate"></div>
                   <div class="greeting" id="greeting"></div>
                   <div class="last-updated" id="lastUpdated">Loading...</div>
                   <div class="contextual-message" id="contextualMessage"></div>
               </div>
   
<div class="header-right">
    <button class="action-btn" id="darkModeToggle">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
        Dark Mode
    </button>
    <button class="action-btn refresh-btn" id="refreshBtn">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/>
        </svg>
        Refresh
    </button>
</div>
           </div>
       </header>
       
       <!-- ü§ñ AI Intelligence Section -->
       <div class="intelligence-section" id="intelligenceSection" style="display: none;">
           <div class="intelligence-header">
               <div class="intelligence-title">
                   <span class="icon">üß†</span>
                   <span>AI Intelligence Digest</span>
               </div>
               <div style="display: flex; align-items: center; gap: 8px;">
                   <div class="threat-indicator" id="threatIndicator">UNKNOWN</div>
                   <button class="intelligence-toggle" id="intelligenceToggle">‚ñº</button>
               </div>
           </div>
           
           <div class="intelligence-content" id="intelligenceContent">
               <div class="intelligence-summary" id="intelligenceSummary">
                   Analyzing current defense industrial base developments...
               </div>
               
               <div class="intelligence-grid">
                   <div class="intelligence-card">
                       <h3>üî• Hot Topics</h3>
                       <ul id="hotTopics">
                           <li>Loading...</li>
                       </ul>
                   </div>
                   
                   <div class="intelligence-card">
                       <h3>üèõÔ∏è Active Agencies</h3>
                       <ul id="activeAgencies">
                           <li>Loading...</li>
                       </ul>
                   </div>
                   
                   <div class="intelligence-card">
                       <h3>üíº Contract Opportunities</h3>
                       <ul id="contractOpportunities">
                           <li>Loading...</li>
                       </ul>
                   </div>
                   
                   <div class="intelligence-card key-developments">
                       <h3>‚ö° Key Developments</h3>
                       <div id="keyDevelopments">
                           <div class="development-item">
                               <div class="development-header">
                                   <span class="development-category">Loading</span>
                                   <span class="development-urgency urgency-low">LOW</span>
                               </div>
                               <div class="development-headline">Analyzing recent developments...</div>
                               <div class="development-significance">AI is processing the latest defense industrial base news.</div>
                           </div>
                       </div>
                   </div>
               </div>
               
               <div class="opportunity-score">
                   <span class="score-label">Market Opportunity</span>
                   <span class="score-value" id="opportunityScoreValue">-</span>
                   <div class="score-bar">
                       <div class="score-fill" id="scoreFill" style="width: 0%"></div>
                   </div>
               </div>
           </div>
       </div>
       
       <div class="filters" id="filterContainer">
           <button class="filter-tab active" data-filter="all">All</button>
       </div>
       
       <div class="error-message" id="errorMessage"></div>
       <div id="content">
           <div class="article-grid">
               <div class="loading">
                   <div class="loading-message" id="loadingMessage">Gathering intelligence...</div>
               </div>
           </div>
       </div>
       
       <footer>
           <div class="footer-content">
               <div class="footer-about">
                   <p>Curated intelligence for Defense professionals, enhanced with AI analysis.</p>
               </div>
               <div class="footer-links">
                   <a href="#" class="share-link" id="shareLink">Share With a Friend.</a>
               </div>
               <div class="footer-copyright">
                   <p>&copy; 2025 DIBDash.com. All rights reserved.</p>
               </div>
           </div>
       </footer>
   </div>
   
   <div class="keyboard-help" id="keyboardHelp">
       <h3>Keyboard Shortcuts</h3>
       <div class="shortcut"><span>Articles</span><kbd>1-9</kbd></div>
       <div class="shortcut"><span>Filter</span><kbd>F</kbd></div>
       <div class="shortcut"><span>Refresh</span><kbd>R</kbd></div>
       <div class="shortcut"><span>Density</span><kbd>D</kbd></div>
       <div class="shortcut"><span>Help</span><kbd>?</kbd></div>
       <div class="shortcut"><span>Close</span><kbd>ESC</kbd></div>
   </div>
   
   <div class="toast" id="toast"></div>
   <div class="modal-overlay" id="contractModal" onclick="if(event.target === this) closeModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalAgencyName">Agency Contracts</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="contracts-list" id="modalContractsList">
            </div>
    </div>
</div>
   <script>
       // Configuration
       const S3_JSON_URL = 'https://askarti-daily-data.s3.us-east-1.amazonaws.com/daily-news.json';
       
       // State
       let articles = [];
       let currentFilter = 'all';
       let isLoading = false;
       let focusMode = false;
       let scrollPosition = 0;
       let intelligenceData = null; // ü§ñ NEW: Store AI intelligence data
       
       // Loading messages
       const loadingMessages = [
           "Gathering intelligence...",
           "Scanning defense channels...", 
           "Checking industry updates...",
           "Analyzing government feeds...",
           "Processing AI insights...", // ü§ñ NEW
           "Almost there...",
           "Compiling your briefing..."
       ];
       let loadingMessageIndex = 0;
       
       // Empty state messages by category
       const emptyStateMessages = {
           defense: ["Intel is quiet today", "All quiet on the defense front", "Defense channels are silent"],
           industry: ["Markets taking a breather", "Industry in stealth mode", "No industry updates"],
           government: ["Capitol Hill is unusually quiet", "Government on pause", "No government activity"],
           all: ["No updates at the moment", "Channels are quiet", "Nothing new to report"]
       };
       
       // UI Elements
       const content = document.getElementById('content');
       const refreshBtn = document.getElementById('refreshBtn');
       const errorMessage = document.getElementById('errorMessage');
       const filterContainer = document.getElementById('filterContainer');
       const lastUpdated = document.getElementById('lastUpdated');
       const greeting = document.getElementById('greeting');
       const currentDateElement = document.getElementById('currentDate');
       const progressBar = document.getElementById('progressBar');
       const shareLink = document.getElementById('shareLink');
       const contextualMessage = document.getElementById('contextualMessage');
       const loadingMessage = document.getElementById('loadingMessage');
       const keyboardHelp = document.getElementById('keyboardHelp');
       const toast = document.getElementById('toast');
       
       // ü§ñ NEW: AI Intelligence UI Elements
       const intelligenceSection = document.getElementById('intelligenceSection');
       const intelligenceToggle = document.getElementById('intelligenceToggle');
       const intelligenceContent = document.getElementById('intelligenceContent');
       const intelligenceSummary = document.getElementById('intelligenceSummary');
       const threatIndicator = document.getElementById('threatIndicator');
       const hotTopics = document.getElementById('hotTopics');
       const activeAgencies = document.getElementById('activeAgencies');
       const contractOpportunities = document.getElementById('contractOpportunities');
       const keyDevelopments = document.getElementById('keyDevelopments');
       const opportunityScoreValue = document.getElementById('opportunityScoreValue');
       const scoreFill = document.getElementById('scoreFill');
       
       // ü§ñ NEW: Intelligence toggle functionality
       intelligenceToggle.addEventListener('click', function() {
           const isCollapsed = intelligenceContent.classList.contains('collapsed');
           if (isCollapsed) {
               intelligenceContent.classList.remove('collapsed');
               intelligenceToggle.textContent = '‚ñº';
           } else {
               intelligenceContent.classList.add('collapsed');
               intelligenceToggle.textContent = '‚ñ∂';
           }
       });

       // ü§ñ NEW: Render AI Intelligence Section
       function renderIntelligenceSection(intelligence) {
           if (!intelligence || !intelligence.digest) {
               intelligenceSection.style.display = 'none';
               return;
           }
           
           const digest = intelligence.digest;
           intelligenceSection.style.display = 'block';
           
           // Update summary
           intelligenceSummary.textContent = digest.executive_summary || 'Processing latest intelligence...';
           
           // Update threat level
           const threatLevel = digest.threat_level || 'unknown';
           threatIndicator.textContent = threatLevel.toUpperCase();
           threatIndicator.className = `threat-indicator threat-${threatLevel}`;
           
           // Update hot topics
           if (digest.market_intelligence?.hot_topics) {
               hotTopics.innerHTML = digest.market_intelligence.hot_topics
                   .slice(0, 5)
                   .map(topic => `<li>${topic}</li>`)
                   .join('');
           }
           
           // Update active agencies
           if (digest.market_intelligence?.active_agencies) {
               activeAgencies.innerHTML = digest.market_intelligence.active_agencies
                   .slice(0, 5)
                   .map(agency => `<li>${agency}</li>`)
                   .join('');
           }
           
           // Update contract opportunities
           if (digest.market_intelligence?.contract_opportunities) {
               contractOpportunities.innerHTML = digest.market_intelligence.contract_opportunities
                   .slice(0, 5)
                   .map(opp => `<li>${opp}</li>`)
                   .join('');
           }
           
           // Update key developments
           if (digest.key_developments) {
               keyDevelopments.innerHTML = digest.key_developments
                   .slice(0, 3)
                   .map(dev => `
                       <div class="development-item">
                           <div class="development-header">
                               <span class="development-category">${dev.category || 'General'}</span>
                               <span class="development-urgency urgency-${dev.urgency || 'low'}">${(dev.urgency || 'low').toUpperCase()}</span>
                           </div>
                           <div class="development-headline">${dev.headline || 'Development Update'}</div>
                           <div class="development-significance">${dev.significance || dev.implications || 'Monitoring for impact on defense industrial base.'}</div>
                       </div>
                   `).join('');
           }
           
           // Update opportunity score
           const score = digest.opportunity_score || 0;
           opportunityScoreValue.textContent = score;
           scoreFill.style.width = `${(score / 10) * 100}%`;
           
           console.log('‚úÖ Intelligence section rendered successfully');
       }

       // URL parameters for preferences
       function getUrlParams() {
           const params = new URLSearchParams(window.location.search);
           return {
               category: params.get('category') || 'all'
           };
       }
       
       function updateUrlParams(key, value) {
           const url = new URL(window.location);
           url.searchParams.set(key, value);
           window.history.replaceState({}, '', url);
       }
       
       // Initialize from URL params
       function initializeFromParams() {
           const params = getUrlParams();
           currentFilter = params.category;
       }
       
       // Show toast notification
       function showToast(message, duration = 2000) {
           toast.textContent = message;
           toast.classList.add('visible');
           setTimeout(() => {
               toast.classList.remove('visible');
           }, duration);
       }
       
       // Set greeting based on time and context
       function setGreetingAndDate() {
           const now = new Date();
           const hour = now.getHours();
           const day = now.getDay();
           
           // Time-based greeting
           let greetingText = 'Good Morning';
           if (hour >= 12 && hour < 17) {
               greetingText = 'Good Afternoon';
           } else if (hour >= 17) {
               greetingText = 'Good Evening';
           }
           
           // Weekend emoji
           const weekendEmoji = (day === 0 || day === 6) ? '<span class="weekend-emoji">‚òï</span>' : '';
           
           // Evening mode
           if (hour >= 20 || hour < 6) {
               document.body.classList.add('evening-mode');
           } else {
               document.body.classList.remove('evening-mode');
           }
           
           const options = { weekday: 'short', day: 'numeric', month: 'long', year: 'numeric' };
           const formattedDate = now.toLocaleDateString('en-US', options);
           
           currentDateElement.textContent = formattedDate;
           greeting.innerHTML = `${greetingText}. Welcome to the Loop. ${weekendEmoji}`;
           
           // Contextual message
           contextualMessage.textContent = getContextualMessage(now);
       }
       
       // Get contextual message based on time/day
       function getContextualMessage(now) {
           const day = now.getDay();
           const hour = now.getHours();
           
           if (day === 1 && hour < 10) return "Monday briefing ready";
           if (day === 5 && hour > 15) return "Weekend preview";
           if (hour > 20) return "Evening digest";
           if (hour < 7) return "Early bird briefing";
           if (day === 0 || day === 6) return "Weekend reading";
           return "";
       }
       
       // Reading progress
       function updateReadingProgress() {
           const scrollTop = window.pageYOffset;
           const docHeight = document.body.scrollHeight - window.innerHeight;
           const scrollPercent = (scrollTop / docHeight) * 100;
           progressBar.style.width = Math.min(scrollPercent, 100) + '%';
       }
       
       // Save scroll position
       function saveScrollPosition() {
           scrollPosition = window.pageYOffset;
       }
       
       function restoreScrollPosition() {
           if (scrollPosition > 0) {
               setTimeout(() => {
                   window.scrollTo({ top: scrollPosition, behavior: 'smooth' });
               }, 100);
           }
       }
       
       // Dark Mode Toggle
       const darkModeToggle = document.getElementById('darkModeToggle');
       const body = document.body;
       
       function enableDarkMode() {
           body.classList.add('dark-mode');
           darkModeToggle.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg> Light Mode`;
           localStorage.setItem('theme', 'dark');
       }
       
       function disableDarkMode() {
           body.classList.remove('dark-mode');
           darkModeToggle.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg> Dark Mode`;
           localStorage.setItem('theme', 'light');
       }
       
       // Check for saved theme preference
       const savedTheme = localStorage.getItem('theme');
       if (savedTheme === 'dark') {
           enableDarkMode();
       } else {
           disableDarkMode();
       }
       
       darkModeToggle.addEventListener('click', () => {
           if (body.classList.contains('dark-mode')) {
               disableDarkMode();
           } else {
               enableDarkMode();
           }
       });
       
       // Utility functions
       function timeAgo(dateString) {
           const now = new Date();
           const date = new Date(dateString);
           const seconds = Math.floor((now - date) / 1000);
           if (seconds < 60) return 'now';
           const minutes = Math.floor(seconds / 60);
           if (minutes < 60) return `${minutes}m`;
           const hours = Math.floor(minutes / 60);
           if (hours < 24) return `${hours}h`;
           const days = Math.floor(hours / 24);
           if (days < 7) return `${days}d`;
           return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
       }
       
       // Get freshness class
       function getFreshnessClass(dateString) {
           const hours = (new Date() - new Date(dateString)) / 3600000;
           if (hours < 2) return 'fresh';
           if (hours < 6) return 'recent';
           return '';
       }
       
       // Get article hints
       function getArticleHints(article) {
           const hints = [];
           
           // Breaking news
           const hours = (new Date() - new Date(article.pubDate)) / 3600000;
           if (hours < 1) hints.push('‚ö°');
           
           // Data/analysis
           if (article.characteristics?.includes('data')) hints.push('üìä');
           
           // Long read
           if (article.characteristics?.includes('longread')) hints.push('üìñ');
           
           // Tech focus
           if (article.characteristics?.includes('tech')) hints.push('üî¨');
           
           return hints;
       }
       
       // Smart truncation
       function smartTruncate(text, maxLength = 200) {
           if (!text || text.length <= maxLength) return text;
           
           const truncated = text.substring(0, maxLength);
           const lastPeriod = truncated.lastIndexOf('. ');
           const lastQuestion = truncated.lastIndexOf('? ');
           const lastExclamation = truncated.lastIndexOf('! ');
           
           const lastBoundary = Math.max(lastPeriod, lastQuestion, lastExclamation);
           
           if (lastBoundary > maxLength * 0.6) {
               return text.substring(0, lastBoundary + 2);
           }
           
           const lastSpace = truncated.lastIndexOf(' ');
           return text.substring(0, lastSpace) + '...';
       }
       
       // Group articles by date
       function groupArticlesByDate(articles) {
           const now = new Date();
           const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
           const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
           const thisWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
           
           const groups = {
               today: { label: 'Today', articles: [] },
               yesterday: { label: 'Yesterday', articles: [] },
               thisWeek: { label: 'This Week', articles: [] },
               older: { label: 'Earlier', articles: [] }
           };
           
           articles.forEach(article => {
               const articleDate = new Date(article.pubDate);
               const articleDay = new Date(articleDate.getFullYear(), articleDate.getMonth(), articleDate.getDate());
               
               if (articleDay.getTime() === today.getTime()) {
                   groups.today.articles.push(article);
               } else if (articleDay.getTime() === yesterday.getTime()) {
                   groups.yesterday.articles.push(article);
               } else if (articleDay.getTime() >= thisWeek.getTime()) {
                   groups.thisWeek.articles.push(article);
               } else {
                   groups.older.articles.push(article);
               }
           });
           
           return groups;
       }
       
       // Get category class for styling
       function getCategoryClass(category) {
           return category ? category.toLowerCase() : '';
       }
       
       // Fetch articles with AI intelligence
       async function fetchArticles() {
           try {
               const response = await fetch(S3_JSON_URL + '?t=' + Date.now());
               if (!response.ok) throw new Error(`HTTP ${response.status}`);
               const data = await response.json();
               
               if (data.summary?.timestamp) {
                   lastUpdated.textContent = `Updated ${timeAgo(data.summary.timestamp)}`;
               }
               
               // ü§ñ NEW: Store AI intelligence data
               intelligenceData = data.intelligence || null;
               
               return data.items || [];
           } catch (error) {
               console.error('Error fetching articles:', error);
               throw error;
           }
       }
       
       // Create category filters
       function createFilters() {
           const categories = [...new Set(articles.map(a => a.category))].filter(Boolean).sort();
           
           // Count fresh articles per category
           const freshCounts = {};
           articles.forEach(article => {
               if (getFreshnessClass(article.pubDate) === 'fresh') {
                   freshCounts[article.category] = (freshCounts[article.category] || 0) + 1;
                   freshCounts['all'] = (freshCounts['all'] || 0) + 1;
               }
           });
           
           filterContainer.innerHTML = `
               <button class="filter-tab ${currentFilter === 'all' ? 'active' : ''}" data-filter="all">
                   All ${freshCounts['all'] ? `<span class="fresh-count">${freshCounts['all']}</span>` : ''}
               </button>
               ${categories.map(category => `
                   <button class="filter-tab ${getCategoryClass(category)} ${currentFilter === category ? 'active' : ''}" data-filter="${category}">
                       ${category.charAt(0).toUpperCase() + category.slice(1)}
                       ${freshCounts[category] ? `<span class="fresh-count">${freshCounts[category]}</span>` : ''}
                   </button>
               `).join('')}
           `;
           
           // Add event listeners
           document.querySelectorAll('.filter-tab').forEach(tab => {
               tab.addEventListener('click', function() {
                   document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                   this.classList.add('active');
                   currentFilter = this.dataset.filter;
                   updateUrlParams('category', currentFilter);
                   saveScrollPosition();
                   renderArticles();
                   restoreScrollPosition();
               });
           });
       }

       // Format currency for contracts
       function formatCurrency(value) {
           if (value >= 1000000000) return `${(value / 1000000000).toFixed(1)}B`;
           if (value >= 1000000) return `${(value / 1000000).toFixed(1)}M`;
           if (value >= 1000) return `${(value / 1000).toFixed(0)}K`;
           return `${value}`;
       }

       // Render contracts section (keeping existing functionality)
       function renderContractsSection(contractsData) {
           if (!contractsData || !contractsData.agencies) {
               return '';
           }
           
           const date = new Date(contractsData.date || new Date()).toLocaleDateString('en-US', { 
               month: 'long', 
               day: 'numeric' 
           });
           
           const insights = contractsData.insights || {
               totalContracts: 0,
               totalValue: 0,
           };
           
           const agencyCards = Object.entries(contractsData.agencies)
               .filter(([agency, data]) => data && data.contracts && data.contracts.length > 0)
               .map(([agency, data]) => {
                   const topContracts = data.contracts
                       .sort((a, b) => b.value - a.value)
                       .slice(0, 3);
                   
                   const typeCount = data.contracts.reduce((acc, contract) => {
                       acc[contract.type] = (acc[contract.type] || 0) + 1;
                       return acc;
                   }, {});
                   
                   const topType = Object.entries(typeCount)
                       .sort((a, b) => b[1] - a[1])[0];
                   
                   return `
                       <div class="agency-card" onclick="showAgencyDetails('${agency}')" tabindex="0">
                           <div class="agency-header">
                               <div class="agency-name">
                                   <span class="agency-icon">${data.icon || 'üìÑ'}</span>
                                   ${agency}
                               </div>
                               <div class="agency-total">${formatCurrency(data.total || 0)}</div>
                           </div>
                           
                           <div class="agency-stats">
                               <div class="stat-item">
                                   <span class="stat-label">Contracts</span>
                                   <span class="stat-value">${data.contracts.length}</span>
                               </div>
                               <div class="stat-item">
                                   <span class="stat-label">Avg Value</span>
                                   <span class="stat-value">${formatCurrency(Math.round((data.total || 0) / data.contracts.length))}</span>
                               </div>
                               <div class="stat-item">
                                   <span class="stat-label">Top Type</span>
                                   <span class="stat-value">${topType ? topType[0] : 'General'}</span>
                               </div>
                           </div>
                           
                           <div class="top-contracts">
                               ${topContracts.map(contract => `
                                   <div class="contract-item">
                                       <span class="contract-company">${contract.company || 'Unknown'}</span>
                                       <span class="contract-value">${contract.formattedValue || formatCurrency(contract.value || 0)}</span>
                                   </div>
                               `).join('')}
                           </div>
                       </div>
                   `;
               }).join('');
           
           if (!agencyCards) {
               return '';
           }
           
           return `
               <div class="contracts-section">
                   <div class="contracts-header">
                       <div class="contracts-title">
                           Contract Awards This Week
                       </div>
                       <div class="contracts-summary">
                           ${insights.totalContracts || 0} contracts ‚Ä¢ ${formatCurrency(insights.totalValue || 0)} total
                       </div>
                   </div>
                   <div class="contracts-grid">
                       ${agencyCards}
                   </div>
               </div>
           `;
       }

       // Store contracts data globally for modal access
       let currentContractsData = null;

       function showAgencyDetails(agencyName) {
          if (!currentContractsData || !currentContractsData.agencies[agencyName]) return;
          
          const agency = currentContractsData.agencies[agencyName];
          const modal = document.getElementById('contractModal');
          const modalContent = document.getElementById('modalContractsList');
          
          document.getElementById('modalAgencyName').textContent = agencyName;
          
          const contractsHtml = agency.contracts
              .sort((a, b) => b.value - a.value)
              .map(contract => `
                  <div class="contract-detail">
                      <div class="contract-detail-header">
                          <span class="contract-detail-company">${contract.company}</span>
                          <span class="contract-detail-value">${contract.formattedValue}</span>
                      </div>
                      <div class="contract-detail-info">
                          <div><strong>Location:</strong> ${contract.location}</div>
                          <div><strong>Type:</strong> ${contract.type} ${contract.isModification ? '(Modification)' : ''}</div>
                          <div><strong>Description:</strong> ${contract.description}</div>
                          ${contract.workLocation ? `<div><strong>Work Location:</strong> ${contract.workLocation}</div>` : ''}
                          ${contract.completionDate ? `<div><strong>Completion:</strong> ${contract.completionDate}</div>` : ''}
                      </div>
                  </div>
              `).join('');
          
          modalContent.innerHTML = contractsHtml;
          modal.classList.add('active');
       }

       function closeModal() {
          document.getElementById('contractModal').classList.remove('active');
       }

       // Stock ticker functionality (keeping existing)
       let stockData = [];
       const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/1svXheHx4C1XVLITnVsW7nbT0v-B8tJxDviZG-Op2v58/gviz/tq?tqx=out:csv&sheet=Sheet1';

       async function fetchStockData() {
           try {
               const response = await fetch(GOOGLE_SHEETS_URL + '&t=' + Date.now());
               if (!response.ok) {
                   throw new Error(`Failed to fetch Google Sheet data: ${response.statusText}`);
               }
               const csv = await response.text();
               const lines = csv.split('\n');
               
               let tickerIndex = -1;
               let priceIndex = -1;
               let percentChangeIndex = -1;
               
               const headers = lines[0].split(',');
               for (let i = 0; i < headers.length; i++) {
                   const header = headers[i].trim().replace(/^"|"$/g, '');
                   if (header === 'Ticker') {
                       tickerIndex = i;
                   }
                   if (header === 'Price') {
                       priceIndex = i;
                   }
                   if (header === 'Change%') {
                       percentChangeIndex = i;
                   }
               }
               
               if (tickerIndex === -1 || priceIndex === -1 || percentChangeIndex === -1) {
                   console.error('Error: Could not find required headers in the Google Sheet.');
                   return [];
               }

               const data = [];
               for (let i = 1; i < lines.length; i++) {
                   const values = lines[i].split(',').map(value => value.trim().replace(/^"|"$/g, ''));
                   if (values.length > tickerIndex && values.length > priceIndex && values.length > percentChangeIndex) {
                       const percentChangeValue = values[percentChangeIndex].replace(/[^0-9.-]/g, '');
                       
                       data.push({
                           ticker: values[tickerIndex],
                           price: parseFloat(values[priceIndex].replace(/[^0-9.]/g, '')),
                           percentChange: parseFloat(percentChangeValue)
                       });
                   }
               }
               return data;
           } catch (error) {
               console.error('Error fetching stock data:', error);
               return [];
           }
       }

       function getStockTickerHtml() {
           if (stockData.length === 0) {
               return '';
           }
           
           const stockItemsHtml = stockData.map(stock => {
               const changeClass = stock.percentChange >= 0 ? 'stock-change-positive' : 'stock-change-negative';
               const changeSign = stock.percentChange >= 0 ? '+' : '';

               return `
                   <div class="stock-item">
                       <span class="stock-ticker">${stock.ticker}</span>
                       <span class="stock-price">${stock.price.toFixed(2)}</span>
                       <span class="stock-percent-change ${changeClass}">${changeSign}${stock.percentChange.toFixed(2)}%</span>
                   </div>
               `;
           }).join('');

           const tickerContent = stockItemsHtml + stockItemsHtml;

           return `
               <div class="stock-ticker-section">
                   <div class="stock-ticker-header">
                       DIB Stocks (20-minute delay)
                   </div>
                   <div class="ticker-scroll-wrapper">
                       <div class="ticker-scroll-content">
                           ${tickerContent}
                       </div>
                   </div>
               </div>
           `;
       }

       function renderAdPlaceholder() {
           return ``;
       }

       // Enhanced renderArticles function with AI intelligence
       async function renderArticles() {
           // Fetch stock data first
           stockData = await fetchStockData();

           const filtered = currentFilter === 'all' 
               ? articles 
               : articles.filter(a => a.category === currentFilter);
           
           // Build the HTML starting with contracts if available
           let html = '';
           
           // ü§ñ NEW: Render AI intelligence section if available and on 'all' filter
           if (intelligenceData && currentFilter === 'all') {
               renderIntelligenceSection(intelligenceData);
           } else {
               intelligenceSection.style.display = 'none';
           }
           
           // Add contracts section at the top if we have contracts data
           if (currentContractsData && currentFilter === 'all') {
               html += renderContractsSection(currentContractsData);
           }

           // Add the stock ticker
           if (currentFilter === 'all') {
               html += getStockTickerHtml();
           }
           
           if (filtered.length === 0) {
               const messages = emptyStateMessages[currentFilter] || emptyStateMessages['all'];
               const randomMessage = messages[Math.floor(Math.random() * messages.length)];
               
               html += `
                   <div class="article-grid">
                       <div class="empty-state">
                           <div class="icon">üìã</div>
                           <h3>${randomMessage}</h3>
                           <p>Try another filter or check back later.</p>
                       </div>
                   </div>
               `;
           } else {
            const groups = groupArticlesByDate(filtered);
            const dateGroups = Object.entries(groups);

            dateGroups.forEach(([key, group]) => {
                if (group.articles.length > 0) {
                    html += `
                        <div class="date-group">
                            <div class="date-group-header">${group.label}</div>
                            <div class="article-grid">
                                ${group.articles.map((article, index) => {
                                    const freshnessClass = getFreshnessClass(article.pubDate);
                                    const hints = getArticleHints(article);
                                    const readingTime = article.readingTime || 2;
                                    
                                    const linkedInUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(article.link)}`;
                                    
                                    return `
                                        <article class="article ${freshnessClass}" 
                                                 data-index="${index}"
                                                 tabindex="0" 
                                                 role="article" 
                                                 aria-label="Article: ${article.title}">
                                            <div class="article-meta">
                                                <span class="article-source ${getCategoryClass(article.category)}">${article.source}</span>
                                                <div class="article-separator"></div>
                                                <span class="article-time">${timeAgo(article.pubDate)}</span>
                                                ${hints.length > 0 ? `
                                                    <div class="article-hints">
                                                        ${hints.map(h => `<span class="hint-emoji"></span>`).join('')}
                                                    </div>
                                                ` : ''}
                                                <span class="reading-time">${readingTime} min</span>
                                            </div>
                                            <h2 class="article-title">${article.title}</h2>
                                            <p class="article-description">${article.description || 'Read more for details.'}</p>
                                            <div class="article-actions">
                                                <a href="${article.link}" target="_blank" class="article-action-button">Read More</a>
                                                <a href="${linkedInUrl}" target="_blank" class="article-action-button">
                                                    Share on LinkedIn
                                                </a>
                                            </div>
                                        </article>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;

                    html += renderAdPlaceholder();
                }
            });
           }

           content.innerHTML = html;
           
           // Add keyboard navigation and focus mode
           document.querySelectorAll('.article').forEach(article => {
               article.addEventListener('keydown', function(e) {
                   if (e.key === 'Enter' || e.key === ' ') {
                       e.preventDefault();
                   }
               });
               
               article.addEventListener('dblclick', function(e) {
                   e.preventDefault();
                   toggleFocusMode(this);
               });
           });
           
           // Add keyboard navigation for agency cards
           document.querySelectorAll('.agency-card').forEach(card => {
               card.addEventListener('keydown', function(e) {
                   if (e.key === 'Enter' || e.key === ' ') {
                       e.preventDefault();
                       this.click();
                   }
               });
           });
       }

       // Update fetchArticles to handle AI intelligence
       async function fetchArticles() {
           try {
               const response = await fetch(S3_JSON_URL + '?t=' + Date.now());
               if (!response.ok) throw new Error(`HTTP ${response.status}`);
               const data = await response.json();
               
               if (data.summary?.timestamp) {
                   lastUpdated.textContent = `Updated ${timeAgo(data.summary.timestamp)}`;
               }
               
               // ü§ñ NEW: Store AI intelligence and contracts data
               intelligenceData = data.intelligence || null;
               currentContractsData = data.contracts || null;
               
               // ü§ñ NEW: Update contextual message with AI insights
               if (intelligenceData?.digest?.threat_level) {
                   const threatLevel = intelligenceData.digest.threat_level;
                   const threatMessages = {
                       low: "All clear ‚Ä¢ Normal operations",
                       moderate: "Monitoring developments",
                       elevated: "Heightened activity detected",
                       high: "Critical developments"
                   };
                   contextualMessage.textContent = threatMessages[threatLevel] || "";
               }
               
               return data.items || [];
           } catch (error) {
               console.error('Error fetching articles:', error);
               throw error;
           }
       }

       // Rest of the JavaScript remains the same...
       // (All the existing functions like refreshFeed, keyboard shortcuts, etc.)
       
       // RSS Fetch endpoint 
       const RSS_FETCH_URL = 'https://jcsmad2nf7gbhxyarmpykpmdwm0bafge.lambda-url.us-east-1.on.aws/';

       async function triggerRSSFetch() {
           const statusElement = document.getElementById('rssFetchStatus');
           const button = document.getElementById('rssFetchBtn');
           
           if (!statusElement || !button) return;
           
           button.disabled = true;
           button.innerHTML = `
               <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spinning">
                   <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
               </svg>
               Fetching RSS...
           `;
           statusElement.textContent = 'Triggering RSS fetch with AI analysis...';
           statusElement.style.color = 'var(--text-secondary)';
           
           try {
               const response = await fetch(RSS_FETCH_URL, {
                   method: 'GET',
                   headers: {
                       'Content-Type': 'application/json'
                   }
               });
               
               if (!response.ok) {
                   throw new Error(`HTTP error! status: ${response.status}`);
               }
               
               const result = await response.json();
               console.log('RSS Fetch result:', result);
               
               // Complete the triggerRSSFetch function
if (result.success) {
    statusElement.textContent = `‚úì Fetched ${result.count || 0} articles with AI intelligence`;
    statusElement.style.color = 'var(--fresh-accent)';
    
    // Refresh the local feed after successful fetch
    setTimeout(() => {
        refreshFeed();
    }, 1000);
} else {
    throw new Error(result.error || 'RSS fetch failed');
}

} catch (error) {
    console.error('Error triggering RSS fetch:', error);
    statusElement.textContent = 'Error: ' + error.message;
    statusElement.style.color = 'var(--breaking-accent)';
} finally {
    // Re-enable button
    button.disabled = false;
    button.innerHTML = `
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        Fetch RSS
    `;
    
    // Clear status after 5 seconds
    setTimeout(() => {
        if (statusElement.textContent.includes('‚úì') || statusElement.textContent.includes('Error:')) {
            statusElement.textContent = '';
        }
    }, 5000);
}
}

// Toggle focus mode
function toggleFocusMode(articleElement) {
    if (focusMode) {
        document.body.classList.remove('focus-mode');
        document.querySelectorAll('.article').forEach(a => a.classList.remove('focused'));
        focusMode = false;
    } else {
        document.body.classList.add('focus-mode');
        articleElement.classList.add('focused');
        focusMode = true;
    }
}

// Cycle loading messages
function cycleLoadingMessage() {
    if (isLoading) {
        loadingMessage.textContent = loadingMessages[loadingMessageIndex];
        loadingMessageIndex = (loadingMessageIndex + 1) % loadingMessages.length;
        setTimeout(cycleLoadingMessage, 800);
    }
}

// Enhanced refresh feed with AI analysis
async function refreshFeed() {
    if (isLoading) return;
    
    isLoading = true;
    refreshBtn.classList.add('loading');
    refreshBtn.disabled = true;
    errorMessage.style.display = 'none';
    
    // Start cycling loading messages
    loadingMessageIndex = 0;
    cycleLoadingMessage();
    
    try {
        // Fetch articles with AI intelligence
        const fetchedArticles = await fetchArticles();
        articles = fetchedArticles;
        
        // Fetch stock data
        stockData = await fetchStockData();
        
        createFilters();
        renderArticles();
        
        // Show enhanced toast with AI info
        if (intelligenceData?.digest) {
            showToast(`Feed refreshed with AI intelligence ‚Ä¢ Threat level: ${intelligenceData.digest.threat_level || 'unknown'}`);
        } else {
            showToast('Feed refreshed');
        }
    } catch (error) {
        errorMessage.style.display = 'block';
        errorMessage.textContent = 'Unable to load content. Please check your connection.';
        content.innerHTML = `
            <div class="article-grid">
                <div class="empty-state">
                    <div class="icon">üì°</div>
                    <h3>Connection Issue</h3>
                    <p>Having trouble reaching sources. Please try again.</p>
                </div>
            </div>
        `;
    } finally {
        isLoading = false;
        refreshBtn.classList.remove('loading');
        refreshBtn.disabled = false;
    }
}

// Keyboard shortcuts (enhanced)
document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    // I: Toggle intelligence section
    if (e.key === 'i' || e.key === 'I') {
        e.preventDefault();
        if (intelligenceSection.style.display !== 'none') {
            intelligenceToggle.click();
        }
    }
    
    // F: Focus on filters
    if (e.key === 'f' || e.key === 'F') {
        e.preventDefault();
        const nextFilter = document.querySelector('.filter-tab:not(.active)');
        if (nextFilter) nextFilter.click();
    }
    
    // R: Refresh
    if (e.key === 'r' || e.key === 'R') {
        e.preventDefault();
        refreshFeed();
    }
    
    // ?: Show help
    if (e.key === '?') {
        e.preventDefault();
        keyboardHelp.classList.toggle('visible');
    }
    
    // ESC: Close help or exit focus mode
    if (e.key === 'Escape') {
        if (keyboardHelp.classList.contains('visible')) {
            keyboardHelp.classList.remove('visible');
        } else if (focusMode) {
            document.body.classList.remove('focus-mode');
            document.querySelectorAll('.article').forEach(a => a.classList.remove('focused'));
            focusMode = false;
        }
    }
});

// Setup share functionality
function setupShare() {
    shareLink.addEventListener('click', function(e) {
        e.preventDefault();
        if (navigator.share) {
            navigator.share({
                title: 'DIBDash - Defense Industrial Base Intelligence',
                text: 'Check out DIBDash - AI-powered intelligence for defense professionals',
                url: window.location.href
            }).catch(err => console.log('Error sharing:', err));
        } else {
            navigator.clipboard.writeText(window.location.href).then(() => {
                showToast('Link copied!');
            }).catch(() => {
                const subject = encodeURIComponent('Check out DIBDash');
                const body = encodeURIComponent('AI-powered defense intelligence: ' + window.location.href);
                window.open(`mailto:?subject=${subject}&body=${body}`);
            });
        }
    });
}
// Add these functions to your existing index.html JavaScript section

// ü§ñ NEW: Configuration for your mainlambda endpoint
const MAIN_LAMBDA_URL = 'https://p55rql7nsrzlaqtcyjaqpjd32a0vdfwu.lambda-url.us-east-1.on.aws/'; // Replace with your actual Lambda URL

// ü§ñ NEW: Fetch or generate intelligence digest
async function fetchIntelligenceDigest(forceGenerate = false) {
    try {
        console.log('ü§ñ Fetching intelligence digest...');
        
        let requestBody;
        if (forceGenerate) {
            // Request to generate new intelligence
            requestBody = {
                situation: "Generate intelligence digest from RSS data",
                mode: "intelligence"
            };
        } else {
            // Request to get existing intelligence
            requestBody = {
                situation: "Get existing intelligence digest", 
                mode: "get-intelligence"
            };
        }
        
        const response = await fetch(MAIN_LAMBDA_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
            if (response.status === 404 && !forceGenerate) {
                // No existing intelligence, try to generate it
                console.log('ü§ñ No existing intelligence found, generating new one...');
                return await fetchIntelligenceDigest(true);
            }
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            console.log('‚úÖ Intelligence digest fetched successfully');
            return result.digest || result; // Handle both response formats
        } else {
            throw new Error(result.error || 'Failed to fetch intelligence');
        }
        
    } catch (error) {
        console.error('‚ùå Error fetching intelligence digest:', error);
        return null;
    }
}

// ü§ñ NEW: Enhanced render intelligence section
function renderIntelligenceSection(intelligenceDigest) {
    if (!intelligenceDigest) {
        intelligenceSection.style.display = 'none';
        return;
    }
    
    intelligenceSection.style.display = 'block';
    
    // Update summary
    intelligenceSummary.textContent = intelligenceDigest.executive_summary || 'Processing latest intelligence...';
    
    // Update threat level
    const threatLevel = intelligenceDigest.threat_level || 'unknown';
    threatIndicator.textContent = threatLevel.toUpperCase();
    threatIndicator.className = `threat-indicator threat-${threatLevel}`;
    
    // Update hot topics
    if (intelligenceDigest.market_intelligence?.hot_topics) {
        hotTopics.innerHTML = intelligenceDigest.market_intelligence.hot_topics
            .slice(0, 5)
            .map(topic => `<li>${topic}</li>`)
            .join('');
    }
    
    // Update active agencies
    if (intelligenceDigest.market_intelligence?.active_agencies) {
        activeAgencies.innerHTML = intelligenceDigest.market_intelligence.active_agencies
            .slice(0, 5)
            .map(agency => `<li>${agency}</li>`)
            .join('');
    }
    
    // Update contract opportunities
    if (intelligenceDigest.market_intelligence?.contract_opportunities) {
        contractOpportunities.innerHTML = intelligenceDigest.market_intelligence.contract_opportunities
            .slice(0, 5)
            .map(opp => `<li>${opp}</li>`)
            .join('');
    }
    
    // Update key developments
    if (intelligenceDigest.key_developments) {
        keyDevelopments.innerHTML = intelligenceDigest.key_developments
            .slice(0, 3)
            .map(dev => `
                <div class="development-item">
                    <div class="development-header">
                        <span class="development-category">${dev.category || 'General'}</span>
                        <span class="development-urgency urgency-${dev.urgency || 'low'}">${(dev.urgency || 'low').toUpperCase()}</span>
                    </div>
                    <div class="development-headline">${dev.headline || 'Development Update'}</div>
                    <div class="development-significance">${dev.significance || dev.implications || 'Monitoring for impact on defense industrial base.'}</div>
                </div>
            `).join('');
    }
    
    // Update opportunity score
    const score = intelligenceDigest.opportunity_score || 0;
    opportunityScoreValue.textContent = score;
    scoreFill.style.width = `${(score / 10) * 100}%`;
    
    // Update last analysis time if available
    if (intelligenceDigest.generated_at) {
        const analysisTime = new Date(intelligenceDigest.generated_at);
        const timeAgoText = timeAgo(analysisTime.toISOString());
        intelligenceSummary.title = `Last analysis: ${timeAgoText}`;
    }
    
    console.log('‚úÖ Intelligence section rendered successfully');
}

// ü§ñ NEW: Add intelligence refresh button functionality
function addIntelligenceRefreshButton() {
    const intelligenceHeader = document.querySelector('.intelligence-header');
    if (!intelligenceHeader) return;
    
    // Check if button already exists
    if (document.getElementById('intelligenceRefreshBtn')) return;
    
    const refreshButton = document.createElement('button');
    refreshButton.id = 'intelligenceRefreshBtn';
    refreshButton.className = 'action-btn';
    refreshButton.innerHTML = `
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        Refresh
    `;
    refreshButton.title = 'Generate fresh intelligence analysis';
    
    refreshButton.addEventListener('click', async () => {
        refreshButton.disabled = true;
        refreshButton.classList.add('loading');
        refreshButton.innerHTML = `
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spinning">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
            </svg>
            Analyzing...
        `;
        
        try {
            const freshIntelligence = await fetchIntelligenceDigest(true);
            if (freshIntelligence) {
                renderIntelligenceSection(freshIntelligence);
                showToast('ü§ñ Fresh intelligence analysis generated');
            } else {
                showToast('‚ùå Failed to generate intelligence');
            }
        } catch (error) {
            console.error('Error refreshing intelligence:', error);
            showToast('‚ùå Intelligence refresh failed');
        } finally {
            refreshButton.disabled = false;
            refreshButton.classList.remove('loading');
            refreshButton.innerHTML = `
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                </svg>
                Refresh
            `;
        }
    });
    
    // Insert before the toggle button
    const controlsDiv = document.createElement('div');
    controlsDiv.style.display = 'flex';
    controlsDiv.style.alignItems = 'center';
    controlsDiv.style.gap = '8px';
    
    controlsDiv.appendChild(refreshButton);
    controlsDiv.appendChild(intelligenceToggle);
    
    intelligenceHeader.appendChild(controlsDiv);
}

// ü§ñ NEW: Enhanced fetch articles function with intelligence integration
async function fetchArticlesWithIntelligence() {
    try {
        // Fetch the standard RSS data
        const response = await fetch(S3_JSON_URL + '?t=' + Date.now());
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        
        if (data.summary?.timestamp) {
            lastUpdated.textContent = `Updated ${timeAgo(data.summary.timestamp)}`;
        }
        
        // ü§ñ NEW: Check if we need to fetch intelligence separately
        let intelligenceDigest = null;
        
        // First, try to get intelligence from the RSS data (if it exists there)
        if (data.intelligence?.digest) {
            intelligenceDigest = data.intelligence.digest;
            console.log('‚úÖ Found intelligence in RSS data');
        } else {
            // If not in RSS data, fetch from mainlambda
            console.log('ü§ñ Fetching intelligence from mainlambda...');
            intelligenceDigest = await fetchIntelligenceDigest();
        }
        
        // Store intelligence data globally
        intelligenceData = intelligenceDigest;
        
        // Update contextual message with AI insights
        if (intelligenceDigest?.threat_level) {
            const threatLevel = intelligenceDigest.threat_level;
            const threatMessages = {
                low: "All clear ‚Ä¢ Normal operations",
                moderate: "Monitoring developments", 
                elevated: "Heightened activity detected",
                high: "Critical developments"
            };
            contextualMessage.textContent = threatMessages[threatLevel] || "";
        }
        
        // Store contracts data
        currentContractsData = data.contracts || null;
        
        return data.items || [];
        
    } catch (error) {
        console.error('Error fetching articles with intelligence:', error);
        throw error;
    }
}

// ü§ñ NEW: Enhanced render articles function
async function renderArticlesWithIntelligence() {
    // Fetch stock data first
    stockData = await fetchStockData();

    const filtered = currentFilter === 'all' 
        ? articles 
        : articles.filter(a => a.category === currentFilter);
    
    // Build the HTML starting with intelligence and contracts
    let html = '';
    
    // ü§ñ NEW: Render AI intelligence section if available and on 'all' filter
    if (intelligenceData && currentFilter === 'all') {
        renderIntelligenceSection(intelligenceData);
        // Add refresh button if not already present
        addIntelligenceRefreshButton();
    } else {
        intelligenceSection.style.display = 'none';
    }
    
    // Add contracts section at the top if we have contracts data
    if (currentContractsData && currentFilter === 'all') {
        html += renderContractsSection(currentContractsData);
    }

    // Add the stock ticker
    if (currentFilter === 'all') {
        html += getStockTickerHtml();
    }
    
    // Rest of the article rendering logic remains the same...
    if (filtered.length === 0) {
        const messages = emptyStateMessages[currentFilter] || emptyStateMessages['all'];
        const randomMessage = messages[Math.floor(Math.random() * messages.length)];
        
        html += `
            <div class="article-grid">
                <div class="empty-state">
                    <div class="icon">üìã</div>
                    <h3>${randomMessage}</h3>
                    <p>Try another filter or check back later.</p>
                </div>
            </div>
        `;
    } else {
        const groups = groupArticlesByDate(filtered);
        const dateGroups = Object.entries(groups);

        dateGroups.forEach(([key, group]) => {
            if (group.articles.length > 0) {
                html += `
                    <div class="date-group">
                        <div class="date-group-header">${group.label}</div>
                        <div class="article-grid">
                            ${group.articles.map((article, index) => {
                                const freshnessClass = getFreshnessClass(article.pubDate);
                                const hints = getArticleHints(article);
                                const readingTime = article.readingTime || 2;
                                
                                const linkedInUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(article.link)}`;
                                
                                return `
                                    <article class="article ${freshnessClass}" 
                                             data-index="${index}"
                                             tabindex="0" 
                                             role="article" 
                                             aria-label="Article: ${article.title}">
                                        <div class="article-meta">
                                            <span class="article-source ${getCategoryClass(article.category)}">${article.source}</span>
                                            <div class="article-separator"></div>
                                            <span class="article-time">${timeAgo(article.pubDate)}</span>
                                            ${hints.length > 0 ? `
                                                <div class="article-hints">
                                                    ${hints.map(h => `<span class="hint-emoji"></span>`).join('')}
                                                </div>
                                            ` : ''}
                                            <span class="reading-time">${readingTime} min</span>
                                        </div>
                                        <h2 class="article-title">${article.title}</h2>
                                        <p class="article-description">${article.description || 'Read more for details.'}</p>
                                        <div class="article-actions">
                                            <a href="${article.link}" target="_blank" class="article-action-button">Read More</a>
                                            <a href="${linkedInUrl}" target="_blank" class="article-action-button">
                                                Share on LinkedIn
                                            </a>
                                        </div>
                                    </article>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;

                html += renderAdPlaceholder();
            }
        });
    }

    content.innerHTML = html;
    
    // Add existing event listeners for articles and agency cards...
    document.querySelectorAll('.article').forEach(article => {
        article.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
            }
        });
        
        article.addEventListener('dblclick', function(e) {
            e.preventDefault();
            toggleFocusMode(this);
        });
    });
    
    document.querySelectorAll('.agency-card').forEach(card => {
        card.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
    });
}

// ü§ñ NEW: Enhanced refresh feed function with intelligence
async function refreshFeedWithIntelligence() {
    if (isLoading) return;
    
    isLoading = true;
    refreshBtn.classList.add('loading');
    refreshBtn.disabled = true;
    errorMessage.style.display = 'none';
    
    // Start cycling loading messages (include AI-related messages)
    loadingMessageIndex = 0;
    cycleLoadingMessage();
    
    try {
        // Fetch articles with AI intelligence
        const fetchedArticles = await fetchArticlesWithIntelligence();
        articles = fetchedArticles;
        
        // Fetch stock data
        stockData = await fetchStockData();
        
        createFilters();
        await renderArticlesWithIntelligence();
        
        // Show enhanced toast with AI info
        if (intelligenceData?.threat_level) {
            showToast(`ü§ñ Feed refreshed with AI intelligence ‚Ä¢ Threat level: ${intelligenceData.threat_level}`);
        } else {
            showToast('Feed refreshed ‚Ä¢ Intelligence analysis pending');
        }
    } catch (error) {
        errorMessage.style.display = 'block';
        errorMessage.textContent = 'Unable to load content. Please check your connection.';
        content.innerHTML = `
            <div class="article-grid">
                <div class="empty-state">
                    <div class="icon">üì°</div>
                    <h3>Connection Issue</h3>
                    <p>Having trouble reaching sources. Please try again.</p>
                </div>
            </div>
        `;
    } finally {
        isLoading = false;
        refreshBtn.classList.remove('loading');
        refreshBtn.disabled = false;
    }
}

// ü§ñ NEW: Override the original functions with intelligence-enhanced versions
// Replace the original fetchArticles function
window.fetchArticles = fetchArticlesWithIntelligence;

// Replace the original renderArticles function  
window.renderArticles = renderArticlesWithIntelligence;

// Replace the original refreshFeed function
window.refreshFeed = refreshFeedWithIntelligence;

// ü§ñ NEW: Add keyboard shortcut for intelligence refresh
document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    // I: Toggle or refresh intelligence section
    if (e.key === 'i' || e.key === 'I') {
        e.preventDefault();
        if (intelligenceSection.style.display !== 'none') {
            const refreshBtn = document.getElementById('intelligenceRefreshBtn');
            if (refreshBtn && !refreshBtn.disabled) {
                refreshBtn.click(); // Refresh intelligence
            } else {
                intelligenceToggle.click(); // Toggle if refresh not available
            }
        }
    }
});

// ü§ñ NEW: Initialize intelligence on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('ü§ñ Initializing intelligence system...');
    
    // Set up intelligence refresh button (will be added when intelligence section is rendered)
    // The button is added dynamically in addIntelligenceRefreshButton()
    
    console.log('‚úÖ Intelligence system initialized');
});

console.log('ü§ñ Intelligence integration loaded successfully');
// Initialize everything
initializeFromParams();
setGreetingAndDate();
refreshFeed();
setupShare();

// Event listeners
window.addEventListener('scroll', updateReadingProgress);
window.addEventListener('beforeunload', saveScrollPosition);
refreshBtn.addEventListener('click', refreshFeed);

// Update greeting every hour
setInterval(setGreetingAndDate, 3600000);

// Auto-refresh every 15 minutes if page is visible
setInterval(() => {
    if (!document.hidden && !isLoading) {
        refreshFeed();
    }
}, 15 * 60 * 1000);
</script>
</body>
</html>