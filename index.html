<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AskArti - Your Fed Sales Buddy</title>
    
    <meta name="description" content="When your customer ghosts you and your boss wants impossible quota. Real federal sales advice that actually works.">
    <meta name="keywords" content="federal sales, government sales, sales strategy, federal contractors, govcon">
    <meta name="author" content="Mark">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://askarti.com">
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://askarti.com/">
    <meta property="og:title" content="AskArti - Your Federal Sales Buddy">
    <meta property="og:description" content="Real federal sales advice from someone who gets it. No BS, just results.">
    <meta property="og:image" content="https://askarti.com/images/asklite.png">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:url" content="https://askarti.com/">
    <meta name="twitter:title" content="AskArti - Your Federal Sales Buddy">
    <meta name="twitter:description" content="Real federal sales advice that actually works.">
    <meta name="twitter:image" content="https://askarti.com/images/asklite.png">
    
    <link rel="icon" href="/images/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#7C6BBE">
    
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <link rel="preload" href="/images/asklite.png" as="image">
    <link rel="preload" href="/images/arti_right.png" as="image">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WLGEPY5H4G"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-WLGEPY5H4G');
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7C6BBE',
                        customPurple: {
                            50: '#F6F5FB',
                            100: '#E8E4F7',
                            200: '#D8D2EF',
                            300: '#C0B6E3',
                            500: '#7C6BBE',
                            700: '#5A4E8C',
                            900: '#403866'
                        }
                    }
                }
            }
        }
    </script>
    
<style>
    body {
        font-family: 'Inter', sans-serif;
        margin: 0;
        padding: 0;
        background-color: #FAFBFC;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* Clean, professional loader */
    .loader {
        border: 2px solid #E5E7EB;
        border-top: 2px solid #7C6BBE;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Subtle animations */
    .fade-in {
        animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Clean chat messages */
    .chat-message-user {
        background-color: #7C6BBE;
        color: white;
        border-radius: 18px 18px 4px 18px;
    }

    .chat-message-arti {
        background-color: #F3F4F6;
        color: #1F2937;
        border-radius: 18px 18px 18px 4px;
    }

    /* Typing indicator */
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 12px 16px;
        background-color: #F3F4F6;
        border-radius: 18px 18px 18px 4px;
        width: fit-content;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background-color: #9CA3AF;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 80%, 100% {
            transform: scale(0.8);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Clean cards */
    .result-card {
        background-color: white;
        border-radius: 12px;
        border: 1px solid #E5E7EB;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: opacity 0.3s ease, height 0.3s ease;
    }

    .result-card[style*="display: none"] {
        opacity: 0;
        height: 0;
        overflow: hidden;
        margin: 0;
        padding: 0;
    }

    /* Mobile-first responsive design */
    .chat-container {
        height: 50vh;
        max-height: 400px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
    }

    @media (min-width: 640px) {
        .chat-container {
            height: 60vh;
            max-height: 500px;
        }
    }

    /* Clean scrollbar */
    .chat-container::-webkit-scrollbar {
        width: 6px;
    }

    .chat-container::-webkit-scrollbar-track {
        background: #F9FAFB;
    }

    .chat-container::-webkit-scrollbar-thumb {
        background: #D1D5DB;
        border-radius: 3px;
    }

    .chat-container::-webkit-scrollbar-thumb:hover {
        background: #9CA3AF;
    }

    /* Mermaid container */
    .mermaid-container {
        background-color: #F9FAFB;
        border-radius: 8px;
        padding: 1rem;
        overflow-x: auto;
    }

    /* Results typography */
    .result-card h3 {
        font-size: 1.125rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 1rem;
    }
    .result-card h4 {
        font-weight: 600;
        color: #1F2937;
        margin-bottom: 0.5rem;
    }

    .result-card p, .result-card li {
        font-size: 0.875rem;
        line-height: 1.6;
        color: #4B5563;
    }

    .result-card strong {
        color: #1F2937;
        font-weight: 600;
    }

    /* Account plan specific styles */
   .account-plan-header {
       background: linear-gradient(135deg, #F6F5FB 0%, #E8E4F7 100%);
       border-radius: 12px;
       padding: 1.5rem;
       margin-bottom: 1.5rem;
   }

   /* Mobile optimizations */
   @media (max-width: 640px) {
       .result-card {
           padding: 1rem;
       }
       input[type="text"] {
           font-size: 16px !important; /* Prevent zoom on iOS */
       }
   }

   /* Print styles */
   @media print {
       body {
           background-color: white;
       }
       .no-print {
           display: none !important;
       }
       .result-card {
           box-shadow: none;
           border: 1px solid #E5E7EB;
           break-inside: avoid;
       }
   }
       /* --- NEW HBR-LEVEL MERMAID STYLES --- */
    .mermaid-container .mermaid svg {
        font-family: 'Inter', sans-serif;
        color: #374151;
    }
    
    /* Style for standard nodes (actions) */
    .mermaid-container .mermaid .node rect,
    .mermaid-container .mermaid .node circle,
    .mermaid-container .mermaid .node polygon {
        fill: #F6F5FB; /* customPurple-50 */
        stroke: #C0B6E3; /* customPurple-300 */
        stroke-width: 2px;
    }

    /* Style for rounded nodes (milestones) */
    .mermaid-container .mermaid .node.rounded rect {
        fill: #E8E4F7; /* customPurple-100 */
    }
    
    /* Style for text inside nodes */
    .mermaid-container .mermaid .node .label {
        color: #403866; /* customPurple-900 */
        font-weight: 500;
    }
    
    /* Style for subgraph titles */
    .mermaid-container .mermaid .subgraph-title {
        font-weight: 600;
        color: #5A4E8C; /* customPurple-700 */
        fill: #5A4E8C;
    }
    .mermaid-container .mermaid .subgraph rect {
        fill: rgba(124, 107, 190, 0.05); /* Transparent primary color */
        stroke: #D8D2EF; /* customPurple-200 */
    }

    /* Style for lines and arrows */
    .mermaid-container .mermaid .edgePath .path {
        stroke: #7C6BBE; /* primary */
        stroke-width: 1.5px;
    }
    .mermaid-container .mermaid .arrowheadPath {
        fill: #7C6BBE; /* primary */
    }
</style>

</head>
<body class="bg-gray-50 text-gray-900">
   <div class="max-w-3xl mx-auto px-4 py-6 min-h-screen">
       <header class="text-center mb-6">
           <a href="/" aria-label="AskArti Home">
               <img src="/images/asklite.png" alt="AskArti" class="h-16 sm:h-20 mx-auto">
           </a>
       </header>

       <main class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
           <div class="p-4 sm:p-6">
               <div class="chat-container mb-4" id="chat-messages">
                   <div class="flex items-start gap-3 mb-4">
                       <img src="/images/arti_right.png" alt="Arti" class="w-8 h-8 rounded-full flex-shrink-0">
                       <div class="chat-message-arti px-4 py-2.5 max-w-[85%]">
                           <p class="text-sm">
                               Hey, I'm Arti, your Federal Sales Buddy. 
                               What's on your mind?
                           </p>
                       </div>
                   </div>
               </div>

               <div class="flex gap-2">
                   <button 
                       id="clear-chat-btn"
                       class="p-2.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors no-print"
                       title="Clear chat">
                       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                       </svg>
                   </button>
                   <input 
                       type="text" 
                       id="chat-input"
                       class="flex-1 px-4 py-2.5 text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-customPurple-500 focus:border-transparent outline-none transition-all"
                       placeholder="What's going on with your deal?"
                       maxlength="500">
                   <button 
                       id="chat-send-btn" 
                       class="px-4 sm:px-6 py-2.5 bg-customPurple-500 hover:bg-customPurple-700 text-white font-medium rounded-lg transition-colors flex items-center gap-2 no-print">
                       <span class="hidden sm:inline">Send</span>
                       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                       </svg>
                   </button>
               </div>
           </div>
       </main>

       <div id="loading-container" class="hidden text-center py-4">
           <div class="inline-flex items-center gap-3 text-gray-600">
                <div class="loader"></div>
               <span id="loading-message" class="text-sm font-medium"></span>
           </div>
       </div>

       <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
           <p class="text-red-700 font-medium text-sm">Connection issues. Even the servers are ghosting us.</p>
           <button id="retry-btn" class="mt-2 text-red-700 underline text-sm">Try again</button>
       </div>
       
       <div id="account-plan-container" class="hidden space-y-4"></div>

       <footer class="text-center mt-12 space-y-4 pb-8 no-print">
           <div class="flex justify-center gap-6 text-sm">
               <button id="about-btn" class="text-customPurple-500 hover:text-customPurple-700 font-medium">About</button>
               <button id="share-btn" class="text-customPurple-500 hover:text-customPurple-700 font-medium">Share</button>
               <a href="mailto:mark@subhoo.com" class="text-customPurple-500 hover:text-customPurple-700 font-medium">Contact</a>
           </div>

           <div class="max-w-xl mx-auto bg-customPurple-50 border border-customPurple-200 rounded-lg p-4 text-sm">
               <p class="text-customPurple-900 font-medium mb-1">Hey there! Enjoying these results?</p>
               <p class="text-customPurple-700">
                  By the time I pay off all my scientists, all the lab coats, and my AWS bill…I'm losin' money every time you Ask Arti something...Sponsor this spot for $99/mo.
               </p>
               <a href="mailto:mark@subhoo.com" class="text-customPurple-500 hover:text-customPurple-700 font-medium underline">
                   Help keep Arti alive →
               </a>
           </div>

           <p class="text-xs text-gray-500 max-w-xl mx-auto">
               AskArti.com results are provided for informational and educational purposes only and do not constitute professional business advice. AI can make errors that may not suit your specific situation. Please consult qualified professionals before making important business decisions.
           </p>

           <p class="text-xs text-gray-400">
               © 2025 AskArti · Built by sellers, for sellers
           </p>
       </footer>
   </div>

   <div id="about-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
       <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
           <div class="flex justify-between items-start mb-4">
               <div class="flex items-center gap-3">
                   <img src="images/oldmark.jpg" alt="Mark" class="w-12 h-12 rounded-full">
                   <div>
                       <h2 class="text-lg font-bold text-gray-900">Hi, I'm Mark</h2>
                       <p class="text-xs text-gray-600">Retired Federal Sales Guy</p>
                   </div>
               </div>
               <button id="close-about" class="text-gray-400 hover:text-gray-600">
                   <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                   </svg>
               </button>
           </div>
           <div class="space-y-3 text-sm text-gray-700">
               <p>
                   I built AskArti to help sellers spend more time with their customers. Arti's not perfect but is available 24/7 when you need to strategize or just vent.
               </p>
               
               <div class="bg-gray-50 rounded-lg p-3 text-xs">
                   <p class="font-medium text-gray-800 mb-1">Privacy First</p>
                   <p class="text-gray-600">
                       Zero storage. Zero tracking. Everything happens in-memory using AWS Serverless and vanishes after your session. 
                       The AI models might learn from our chats, but I don't keep anything.
                   </p>
               </div>
               
               <div class="pt-3">
                   <a href="https://calendly.com/markflournoy/30min" target="_blank" 
                      class="block w-full bg-customPurple-500 hover:bg-customPurple-700 text-white font-medium py-2.5 rounded-lg text-center transition-colors">
                       Want to chat about AI or Sales? →
                   </a>
               </div>
           </div>
       </div>
   </div>
<script>
// Configuration
const CONFIG = {
    API_ENDPOINT: 'https://vd823jgh0a.execute-api.us-east-1.amazonaws.com/prod/AskArtiAPI',
    REQUEST_TIMEOUT: 25000,
    MAX_RETRIES: 2,
    RETRY_DELAY: 2000,
    MAX_INPUT_LENGTH: 500,
    LOADING_MESSAGES: [
        "Analyzing the market...",
        "Deconstructing the situation...",
        "Consulting the knowledge base...",
        "Synthesizing strategy..."
    ]
};

// Clean, focused application class
class AskArti {
    constructor() {
        this.elements = this.getElements();
        this.state = {
            pendingRequest: false,
            lastQuery: '',
            chatHistory: [],
            hasActiveResults: false
        };
        this.init();
    }

    getElements() {
        return {
            chatMessages: document.getElementById('chat-messages'),
            chatInput: document.getElementById('chat-input'),
            chatSendBtn: document.getElementById('chat-send-btn'),
            clearChatBtn: document.getElementById('clear-chat-btn'),
            loadingContainer: document.getElementById('loading-container'),
            loadingMessage: document.getElementById('loading-message'),
            errorMessage: document.getElementById('error-message'),
            retryBtn: document.getElementById('retry-btn'),
            accountPlanContainer: document.getElementById('account-plan-container'),
            aboutBtn: document.getElementById('about-btn'),
            aboutModal: document.getElementById('about-modal'),
            closeAbout: document.getElementById('close-about'),
            shareBtn: document.getElementById('share-btn')
        };
    }

    init() {
        this.initializeMermaid();
        this.setupEventListeners();
        this.elements.chatInput.focus();
    }

    initializeMermaid() {
        mermaid.initialize({ 
            startOnLoad: false,
            securityLevel: 'strict',
            theme: 'default',
            flowchart: {
                htmlLabels: true,
                curve: 'linear'
            }
        });
    }

    setupEventListeners() {
        this.elements.chatSendBtn.addEventListener('click', () => this.sendChatMessage());
        this.elements.chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendChatMessage();
            }
        });
        this.elements.clearChatBtn.addEventListener('click', () => this.clearChat());
        this.elements.retryBtn.addEventListener('click', () => this.retry());
        this.elements.aboutBtn.addEventListener('click', () => this.showModal());
        this.elements.closeAbout.addEventListener('click', () => this.hideModal());
        this.elements.aboutModal.addEventListener('click', (e) => {
            if (e.target === this.elements.aboutModal) this.hideModal();
        });
        this.elements.shareBtn.addEventListener('click', () => this.share());
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') this.hideModal();
        });
    }

    clearChat() {
        this.state.chatHistory = [];
        this.state.hasActiveResults = false;
        
        this.elements.chatMessages.innerHTML = `
            <div class="flex items-start gap-3 mb-4">
                <img src="/images/arti_right.png" alt="Arti" class="w-8 h-8 rounded-full flex-shrink-0">
                <div class="chat-message-arti px-4 py-2.5 max-w-[85%]">
                    <p class="text-sm">
                        Fresh start. What's on your mind?
                    </p>
                </div>
            </div>`;
        
        this.elements.chatInput.value = '';
        this.clearResults();
        
        const planBtns = document.querySelectorAll('#generate-plan-container');
        planBtns.forEach(btn => btn.remove());
        
        this.elements.chatInput.focus();
    }

    clearResults() {
        this.elements.accountPlanContainer.innerHTML = '';
        this.elements.accountPlanContainer.classList.add('hidden');
    }

    addChatMessage(content, isUser = false) {
        const messageHtml = isUser ? `
            <div class="flex justify-end mb-4 fade-in">
                <div class="chat-message-user px-4 py-2.5 max-w-[85%] text-sm">
                    ${content}
                </div>
            </div>
        ` : `
            <div class="flex items-start gap-3 mb-4 fade-in">
                <img src="/images/arti_right.png" alt="Arti" class="w-8 h-8 rounded-full flex-shrink-0">
                <div class="chat-message-arti px-4 py-2.5 max-w-[85%]">
                    <div class="text-sm">${marked.parse(content)}</div>
                </div>
            </div>
        `;
        this.elements.chatMessages.insertAdjacentHTML('beforeend', messageHtml);
        this.scrollChatToBottom();
    }

    showTypingIndicator() {
        const typingHtml = `
            <div id="typing-indicator" class="flex items-start gap-3 mb-4">
                <img src="/images/arti_right.png" alt="Arti" class="w-8 h-8 rounded-full flex-shrink-0 opacity-50">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        `;
        this.elements.chatMessages.insertAdjacentHTML('beforeend', typingHtml);
        this.scrollChatToBottom();
    }

    hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    showLoading() {
        const message = CONFIG.LOADING_MESSAGES[Math.floor(Math.random() * CONFIG.LOADING_MESSAGES.length)];
        this.elements.loadingMessage.textContent = message;
        this.elements.loadingContainer.classList.remove('hidden');
    }

    hideLoading() {
        this.elements.loadingContainer.classList.add('hidden');
    }

    scrollChatToBottom() {
        const container = this.elements.chatMessages;
        if (container) {
            setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50);
        }
    }

    async sendChatMessage() {
        const message = this.elements.chatInput.value.trim();
        if (this.state.pendingRequest || !message) return;

        this.clearResults();
        this.addChatMessage(message, true);
        this.elements.chatInput.value = '';
        this.state.lastQuery = message;
        
        const isFirstMessage = this.state.chatHistory.length === 0;
        this.state.chatHistory.push({ role: 'user', content: message });

        this.state.pendingRequest = true;

        if (isFirstMessage) {
            this.showLoading();
        } else {
            this.showTypingIndicator();
        }

        try {
            const response = await this.makeApiRequest({
                situation: message,
                conversationHistory: this.state.chatHistory
            });

            this.hideTypingIndicator();
            this.hideLoading();

            // --- KEY CHANGE: Detect response type (Zero-Shot Plan vs. Chat) ---
            if (response.account_name) {
                console.log('Zero-shot plan received, displaying directly.');
                this.state.hasActiveResults = true;
                // Add a placeholder assistant message to history so the next turn has context
                this.state.chatHistory.push({ role: 'assistant', content: "Generated a strategic plan." });
                this.displayAccountPlan(response);
            } else {
                // Handle as a standard chat message
                const aiMessage = response.message || "Tell me more.";
                this.addChatMessage(aiMessage, false);
                this.state.chatHistory.push({ role: 'assistant', content: aiMessage });

                if (response.ready_for_plan) {
                    setTimeout(() => { this.generateStrategicPlan(); }, 1000);
                } else if (response.readiness_score >= 7 && !document.getElementById('generate-plan-container')) {
                    setTimeout(() => { this.addStrategicPlanButton(); }, 500);
                }
            }
            this.state.lastQuery = '';
        } catch (error) {
            console.error('API request failed:', error);
            this.hideTypingIndicator();
            this.hideLoading();
            this.showError();
        } finally {
            this.state.pendingRequest = false;
        }
    }
    
    async makeApiRequest(payload) {
        // This single function now handles all API calls.
        // The backend determines the logic based on conversationHistory.
        const response = await fetch(CONFIG.API_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                ...payload,
                mode: payload.mode || 'chat', // default to chat if not specified
                currentDate: new Date().toISOString().split('T')[0]
            })
        });

        if (!response.ok) throw new Error(`Request failed with status ${response.status}`);
        return await response.json();
    }

    addStrategicPlanButton() {
        // Only add button if one doesn't already exist
        if (document.getElementById('generate-plan-container')) return;

        const btnHtml = `
            <div id="generate-plan-container" class="flex justify-center my-4 px-4 fade-in">
                <button onclick="app.generateStrategicPlan()" 
                    class="px-6 py-3 bg-customPurple-500 hover:bg-customPurple-700 text-white font-medium rounded-lg text-sm transition-colors shadow-md">
                    Create My Strategic Plan →
                </button>
            </div>
        `;
        this.elements.chatMessages.insertAdjacentHTML('beforeend', btnHtml);
        this.scrollChatToBottom();
    }

    async generateStrategicPlan() {
        if (this.state.pendingRequest) return;
        
        const planContainer = document.getElementById('generate-plan-container');
        if (planContainer) planContainer.remove();

        this.clearResults();
        this.showLoading();
        
        this.elements.accountPlanContainer.classList.remove('hidden');
        this.elements.accountPlanContainer.scrollIntoView({ behavior: 'smooth' });
        
        this.state.pendingRequest = true;
        
        try {
            const response = await this.makeApiRequest({ 
                situation: "Generate strategic plan based on our conversation",
                mode: 'strategic_plan',
                conversationHistory: this.state.chatHistory
            });
            
            this.hideLoading();
            this.state.hasActiveResults = true;
            this.displayAccountPlan(response);
            
        } catch (error) {
            console.error('Strategic plan generation failed:', error);
            this.hideLoading();
            this.showError();
        } finally {
            this.state.pendingRequest = false;
        }
    }

    displayAccountPlan(data) {
        const { 
            account_name = 'Strategic Plan',
            executive_summary = '',
            strategic_assessment = {},
            partner_ecosystem = {}, // New field
            next_steps = [],
            stakeholder_strategy = [],
            communication_framework = {},
            strategic_diagram
        } = data;
        
        let html = `
            <div class="account-plan-header">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">${account_name}</h2>
                        <p class="text-sm text-gray-600">Analysis & Recommendations</p>
                    </div>
                    <div class="flex gap-2 no-print">
                        <button onclick="window.print()" class="p-2 text-gray-600 hover:text-gray-800 hover:bg-white/50 rounded-lg transition-colors" title="Print">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z" /></svg>
                        </button>
                    </div>
                </div>
            </div>

            ${executive_summary ? `<div class="result-card bg-customPurple-50 border-customPurple-200"><h3>Executive Summary</h3><p>${executive_summary}</p></div>` : ''}

            ${strategic_assessment && Object.keys(strategic_assessment).length > 0 ? `
                <div class="result-card">
                    <h3>Strategic Assessment</h3>
                    ${strategic_assessment.current_state ? `<div class="mb-4"><h4>Current State</h4><p>${strategic_assessment.current_state}</p></div>` : ''}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${strategic_assessment.key_challenges ? `<div><h4>Key Challenges</h4><ul class="space-y-1">${strategic_assessment.key_challenges.map(c => `<li class="flex items-start gap-2"><span class="text-red-500 mt-1.5 text-xs">▪</span><span>${c}</span></li>`).join('')}</ul></div>` : ''}
                        ${strategic_assessment.opportunities ? `<div><h4>Opportunities</h4><ul class="space-y-1">${strategic_assessment.opportunities.map(o => `<li class="flex items-start gap-2"><span class="text-green-500 mt-1.5 text-xs">▪</span><span>${o}</span></li>`).join('')}</ul></div>` : ''}
                    </div>
                </div>
            ` : ''}
            
            ${/* --- NEW: RENDER PARTNER ECOSYSTEM --- */''}
            ${partner_ecosystem && Object.keys(partner_ecosystem).length > 0 ? `
                <div class="result-card">
                    <h3>Partner Ecosystem Analysis</h3>
                    <div class="space-y-4">
                        ${partner_ecosystem.top_prime_contractors ? `<div><h4>Top Prime Contractors</h4><ul class="space-y-2">${partner_ecosystem.top_prime_contractors.map(c => `<li><strong>${c.split(':')[0]}:</strong> ${c.split(':')[1] || ''}</li>`).join('')}</ul></div>` : ''}
                        ${partner_ecosystem.potential_isv_partners ? `<div><h4>Potential ISV Partners</h4><ul class="space-y-2">${partner_ecosystem.potential_isv_partners.map(p => `<li><strong>${p.split(':')[0]}:</strong> ${p.split(':')[1] || ''}</li>`).join('')}</ul></div>` : ''}
                        ${partner_ecosystem.competitive_landscape ? `<div><h4>Competitive Landscape</h4><p>${partner_ecosystem.competitive_landscape}</p></div>` : ''}
                    </div>
                </div>
            ` : ''}

            ${next_steps && next_steps.length > 0 ? `
                <div class="result-card">
                    <h3>Next Steps</h3>
                    <div class="space-y-4">${next_steps.map(step => `
                        <div class="border-l-4 ${step.priority === 'immediate' ? 'border-red-500' : step.priority === 'high' ? 'border-orange-500' : 'border-blue-500'} pl-4 py-2">
                            <div class="flex justify-between items-start gap-2 mb-1">
                                <h4 class="font-semibold text-gray-900 leading-tight">${step.action}</h4>
                                <span class="text-xs font-medium px-2 py-1 rounded-full whitespace-nowrap ${step.priority === 'immediate' ? 'bg-red-100 text-red-800' : step.priority === 'high' ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800'}">${step.priority} | ${step.timeline}</span>
                            </div>
                            <p class="text-sm text-gray-700">${step.rationale}</p>
                        </div>`).join('')}
                    </div>
                </div>
            ` : ''}

            ${stakeholder_strategy && stakeholder_strategy.length > 0 ? `
                <div class="result-card">
                    <h3>Stakeholder Strategy</h3>
                    <div class="space-y-4">${stakeholder_strategy.map(group => `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="mb-2">${group.stakeholder_group}</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div><strong>Approach:</strong> ${group.approach}</div>
                                <div><strong>Key Messages:</strong> ${group.key_messages}</div>
                            </div>
                            ${group.success_metrics ? `<div class="mt-3 text-sm"><strong>Success Metrics:</strong> ${group.success_metrics}</div>` : ''}
                        </div>`).join('')}
                    </div>
                </div>
            ` : ''}

            ${communication_framework && Object.keys(communication_framework).length > 0 ? `
                <div class="result-card">
                    <h3>Communication Framework</h3>
                    ${communication_framework.key_messages ? `<div class="mb-4"><h4>Key Messages</h4><ul class="space-y-1 list-disc list-inside">${communication_framework.key_messages.map(msg => `<li>${msg}</li>`).join('')}</ul></div>` : ''}
                    ${communication_framework.email_template ? `<div><h4>Email Template</h4><div class="bg-gray-50 rounded-lg p-3 text-xs font-mono whitespace-pre-wrap border border-gray-200">${communication_framework.email_template}</div></div>` : ''}
                </div>
            ` : ''}

            ${strategic_diagram && strategic_diagram.trim() ? `
                <div class="result-card">
                    <h3>Framework</h3>
                    <div class="mermaid-container">
                        <div id="mermaid-diagram" class="mermaid">${strategic_diagram}</div>
                    </div>
                </div>
            ` : ''}
        `;
        
        this.elements.accountPlanContainer.innerHTML = html;
        
        if (strategic_diagram && strategic_diagram.trim()) {
            this.renderMermaidChart();
        }
    }
    
    renderMermaidChart() {
        setTimeout(async () => {
            try {
                const mermaidElement = document.querySelector('#mermaid-diagram');
                if (!mermaidElement || !mermaidElement.textContent.trim()) return;
                
                mermaidElement.textContent = this.cleanMermaidSyntax(mermaidElement.textContent.trim());
                await mermaid.run({ nodes: [mermaidElement] });
                
                const svgElement = mermaidElement.querySelector('svg');
                if (!svgElement || svgElement.children.length === 0) {
                    throw new Error('Mermaid rendering produced an empty SVG.');
                }
            } catch (error) {
                console.error('Chart failed to render:', error);
                const container = document.querySelector('#mermaid-diagram')?.closest('.result-card');
                if (container) container.style.display = 'none';
            }
        }, 100);
    }

    cleanMermaidSyntax(code) {
        return code.replace(/["“]/g, '"').replace(/['‘]/g, "'").trim();
    }

    share() {
        const shareData = {
            title: 'AskArti',
            text: 'Federal sales advice that actually works',
            url: 'https://askarti.com'
        };
        
        if (navigator.share) {
            navigator.share(shareData).catch(console.error);
        } else {
            navigator.clipboard.writeText(`${shareData.text} - ${shareData.url}`)
                .then(() => {
                    this.elements.shareBtn.textContent = 'Link Copied!';
                    setTimeout(() => this.elements.shareBtn.textContent = 'Share', 2000);
                });
        }
    }

    showError() {
        this.elements.errorMessage.classList.remove('hidden');
    }

    retry() {
        this.elements.errorMessage.classList.add('hidden');
        if (this.state.lastQuery) {
            this.elements.chatInput.value = this.state.lastQuery;
            this.sendChatMessage();
        }
    }

    showModal() {
        this.elements.aboutModal.classList.remove('hidden');
    }

    hideModal() {
        this.elements.aboutModal.classList.add('hidden');
    }
}

// Initialize
const app = new AskArti();
</script>
</body>
</html>