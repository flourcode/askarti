<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AskArti - Your Fed Sales Buddy</title>
    
    <!-- Meta Tags -->
    <meta name="description" content="When your customer ghosts you and your boss wants impossible quota. Real federal sales advice that actually works.">
    <meta name="keywords" content="federal sales, government sales, sales strategy, federal contractors, govcon">
    <meta name="author" content="Mark">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://askarti.com">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://askarti.com/">
    <meta property="og:title" content="AskArti - Your Federal Sales Buddy">
    <meta property="og:description" content="Real federal sales advice from someone who gets it. No BS, just results.">
    <meta property="og:image" content="https://askarti.com/images/asklite.png">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:url" content="https://askarti.com/">
    <meta name="twitter:title" content="AskArti - Your Federal Sales Buddy">
    <meta name="twitter:description" content="Real federal sales advice that actually works.">
    <meta name="twitter:image" content="https://askarti.com/images/asklite.png">
    
    <!-- Favicons -->
    <link rel="icon" href="/images/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#7C6BBE">
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Preload critical assets -->
    <link rel="preload" href="/images/asklite.png" as="image">
    <link rel="preload" href="/images/arti_right.png" as="image">
    
    <!-- Styles and Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WLGEPY5H4G"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-WLGEPY5H4G');
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7C6BBE',
                        customPurple: {
                            50: '#F6F5FB',
                            100: '#E8E4F7',
                            200: '#D8D2EF',
                            300: '#C0B6E3',
                            500: '#7C6BBE',
                            700: '#5A4E8C',
                            900: '#403866'
                        }
                    }
                }
            }
        }
    </script>
    
<style>
    body {
        font-family: 'Inter', sans-serif;
        margin: 0;
        padding: 0;
        background-color: #FAFBFC;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* Clean, professional loader */
    .loader {
        border: 2px solid #E5E7EB;
        border-top: 2px solid #7C6BBE;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Subtle animations */
    .fade-in {
        animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Clean chat messages */
    .chat-message-user {
        background-color: #7C6BBE;
        color: white;
        border-radius: 18px 18px 4px 18px;
    }

    .chat-message-arti {
        background-color: #F3F4F6;
        color: #1F2937;
        border-radius: 18px 18px 18px 4px;
    }

    /* Typing indicator */
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 12px 16px;
        background-color: #F3F4F6;
        border-radius: 18px 18px 18px 4px;
        width: fit-content;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background-color: #9CA3AF;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 80%, 100% {
            transform: scale(0.8);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Clean cards */
    .result-card {
        background-color: white;
        border-radius: 12px;
        border: 1px solid #E5E7EB;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: opacity 0.3s ease, height 0.3s ease;
    }

    .result-card[style*="display: none"] {
        opacity: 0;
        height: 0;
        overflow: hidden;
        margin: 0;
        padding: 0;
    }

    /* Mobile-first responsive design */
    .chat-container {
        height: 50vh;
        max-height: 400px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    @media (min-width: 640px) {
        .chat-container {
            height: 60vh;
            max-height: 500px;
        }
    }

    /* Clean scrollbar */
    .chat-container::-webkit-scrollbar {
        width: 6px;
    }

    .chat-container::-webkit-scrollbar-track {
        background: #F9FAFB;
    }

    .chat-container::-webkit-scrollbar-thumb {
        background: #D1D5DB;
        border-radius: 3px;
    }

    .chat-container::-webkit-scrollbar-thumb:hover {
        background: #9CA3AF;
    }

    /* Mermaid container */
    .mermaid-container {
        background-color: #F9FAFB;
        border-radius: 8px;
        padding: 1rem;
        overflow-x: auto;
    }

    /* Results typography */
    .result-card h3 {
        font-size: 1.125rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 1rem;
    }

    .result-card p, .result-card li {
        font-size: 0.875rem;
        line-height: 1.6;
        color: #4B5563;
    }

    .result-card strong {
        color: #1F2937;
        font-weight: 600;
    }

    /* Account plan specific styles */
   .account-plan-header {
       background: linear-gradient(135deg, #F6F5FB 0%, #E8E4F7 100%);
       border-radius: 12px;
       padding: 1.5rem;
       margin-bottom: 1.5rem;
   }

   /* Table styles */
   .data-table {
       font-size: 0.875rem;
   }

   .data-table th {
       font-weight: 600;
       color: #6B7280;
       text-transform: uppercase;
       font-size: 0.75rem;
       letter-spacing: 0.05em;
   }

   .data-table td {
       color: #374151;
   }

   /* Mobile optimizations */
   @media (max-width: 640px) {
       .result-card {
           padding: 1rem;
       }


       input[type="text"] {
           font-size: 16px !important; /* Prevent zoom on iOS */
       }
   }

   /* Print styles */
   @media print {
       body {
           background-color: white;
       }
       
       .no-print {
           display: none !important;
       }
       
       .result-card {
           box-shadow: none;
           border: 1px solid #E5E7EB;
           break-inside: avoid;
       }
   }
</style>

</head>
<body class="bg-gray-50 text-gray-900">
   <div class="max-w-3xl mx-auto px-4 py-6 min-h-screen">
       <!-- Clean header -->
       <header class="text-center mb-6">
           <a href="/" aria-label="AskArti Home">
               <img src="/images/asklite.png" alt="AskArti" class="h-16 sm:h-20 mx-auto">
           </a>
       </header>

       <!-- Main chat interface -->
       <main class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
           <div class="p-4 sm:p-6">
               <!-- Chat messages -->
               <div class="chat-container mb-4" id="chat-messages">
                   <div class="flex items-start gap-3 mb-4">
                       <img src="/images/arti_right.png" alt="Arti" class="w-8 h-8 rounded-full flex-shrink-0">
                       <div class="chat-message-arti px-4 py-2.5 max-w-[85%]">
                           <p class="text-sm">
                               Hey, I'm Arti, your Federal Sales Buddy. 
                               What's on your mind?
                           </p>
                       </div>
                   </div>
               </div>

               <!-- Input area -->
               <div class="flex gap-2">
                   <button 
                       id="clear-chat-btn"
                       class="p-2.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors no-print"
                       title="Clear chat">
                       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                       </svg>
                   </button>
                   <input 
                       type="text" 
                       id="chat-input"
                       class="flex-1 px-4 py-2.5 text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-customPurple-500 focus:border-transparent outline-none transition-all"
                       placeholder="What's going on with your deal?"
                       maxlength="500">
                   <button 
                       id="chat-send-btn" 
                       class="px-4 sm:px-6 py-2.5 bg-customPurple-500 hover:bg-customPurple-700 text-white font-medium rounded-lg transition-colors flex items-center gap-2 no-print">
                       <span class="hidden sm:inline">Send</span>
                       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                       </svg>
                   </button>
               </div>
           </div>

       </main>

       <!-- Loading state -->
       <div id="loading-container" class="hidden text-center py-4">
           <div class="inline-flex items-center gap-3 text-gray-600">
               <span id="loading-message" class="text-sm font-medium"></span>
           </div>
       </div>

       <!-- Error state -->
       <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
           <p class="text-red-700 font-medium text-sm">Connection issues. Even the servers are ghosting us.</p>
           <button id="retry-btn" class="mt-2 text-red-700 underline text-sm">Try again</button>
       </div>

       <!-- Results container -->
       <div id="results-container" class="space-y-4"></div>
       
       <!-- Account Plan container -->
       <div id="account-plan-container" class="hidden space-y-4"></div>

       <!-- Footer -->
       <footer class="text-center mt-12 space-y-4 pb-8 no-print">
           <div class="flex justify-center gap-6 text-sm">
               <button id="about-btn" class="text-customPurple-500 hover:text-customPurple-700 font-medium">About</button>
               <button id="share-btn" class="text-customPurple-500 hover:text-customPurple-700 font-medium">Share</button>
               <a href="mailto:mark@subhoo.com" class="text-customPurple-500 hover:text-customPurple-700 font-medium">Contact</a>
           </div>

           <!-- Sponsor message -->
           <div class="max-w-xl mx-auto bg-customPurple-50 border border-customPurple-200 rounded-lg p-4 text-sm">
               <p class="text-customPurple-900 font-medium mb-1">Hey there! Enjoying these results?</p>
               <p class="text-customPurple-700">
                  By the time I pay off all my scientists, all the lab coats, and my AWS bill…I'm losin' money every time you Ask Arti something...Sponsor this spot for $99/mo.
               </p>
               <a href="mailto:mark@subhoo.com" class="text-customPurple-500 hover:text-customPurple-700 font-medium underline">
                   Help keep Arti alive →
               </a>
           </div>

           <p class="text-xs text-gray-500 max-w-xl mx-auto">
               AskArti.com results are provided for informational and educational purposes only and do not constitute professional business advice. AI can make errors that may not suit your specific situation. Please consult qualified professionals before making important business decisions.
           </p>

           <p class="text-xs text-gray-400">
               © 2025 AskArti · Built by sellers, for sellers
           </p>
       </footer>
   </div>

   <!-- About Modal -->
   <div id="about-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
       <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
           <div class="flex justify-between items-start mb-4">
               <div class="flex items-center gap-3">
                   <img src="images/oldmark.jpg" alt="Mark" class="w-12 h-12 rounded-full">
                   <div>
                       <h2 class="text-lg font-bold text-gray-900">Hi, I'm Mark</h2>
                       <p class="text-xs text-gray-600">Retired Federal Sales Guy</p>
                   </div>
               </div>
               <button id="close-about" class="text-gray-400 hover:text-gray-600">
                   <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                   </svg>
               </button>
           </div>
           <div class="space-y-3 text-sm text-gray-700">
               <p>
                   I built AskArti to help sellers spend more time with their customers. Arti's not perfect but is available 24/7 when you need to strategize or just vent.
               </p>
               
               <div class="bg-gray-50 rounded-lg p-3 text-xs">
                   <p class="font-medium text-gray-800 mb-1">Privacy First</p>
                   <p class="text-gray-600">
                       Zero storage. Zero tracking. Everything happens in-memory using AWS Serverless and vanishes after your session. 
                       The AI models might learn from our chats, but I don't keep anything.
                   </p>
               </div>
               
               <div class="pt-3">
                   <a href="https://calendly.com/markflournoy/30min" target="_blank" 
                      class="block w-full bg-customPurple-500 hover:bg-customPurple-700 text-white font-medium py-2.5 rounded-lg text-center transition-colors">
                       Want to chat about AI or Sales? →
                   </a>
               </div>
           </div>
       </div>
   </div>
<script>
// Configuration
const CONFIG = {
    API_ENDPOINT: 'https://vd823jgh0a.execute-api.us-east-1.amazonaws.com/prod/AskArtiAPI',
    REQUEST_TIMEOUT: 25000,
    MAX_RETRIES: 2,
    RETRY_DELAY: 2000,
    MAX_INPUT_LENGTH: 500,
    LOADING_MESSAGES: [
        "Working backwards...",
        "Thinking big...",
        "Circling back...",
        "Unpacking this...",
        "Putting a pin in it..."
    ]
};

// Clean, focused application class
class AskArti {
    constructor() {
        this.elements = this.getElements();
        this.state = {
            pendingRequest: false,
            lastQuery: '',
            chatHistory: [],
            messageCount: 0,
            hasActiveResults: false
        };
        this.init();
    }

    getElements() {
        return {
            chatMessages: document.getElementById('chat-messages'),
            chatInput: document.getElementById('chat-input'),
            chatSendBtn: document.getElementById('chat-send-btn'),
            clearChatBtn: document.getElementById('clear-chat-btn'),
            loadingContainer: document.getElementById('loading-container'),
            loadingMessage: document.getElementById('loading-message'),
            errorMessage: document.getElementById('error-message'),
            retryBtn: document.getElementById('retry-btn'),
            accountPlanContainer: document.getElementById('account-plan-container'),
            aboutBtn: document.getElementById('about-btn'),
            aboutModal: document.getElementById('about-modal'),
            closeAbout: document.getElementById('close-about'),
            shareBtn: document.getElementById('share-btn')
        };
    }

    init() {
        this.initializeMermaid();
        this.setupEventListeners();
        this.elements.chatInput.focus();
    }

    initializeMermaid() {
        mermaid.initialize({ 
            startOnLoad: false,
            securityLevel: 'strict',
            theme: 'default',
            flowchart: {
                htmlLabels: true,
                curve: 'linear'
            }
        });
    }

    setupEventListeners() {
        // Chat events
        this.elements.chatSendBtn.addEventListener('click', () => this.sendChatMessage());
        this.elements.chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendChatMessage();
            }
        });

        this.elements.clearChatBtn.addEventListener('click', () => this.clearChat());
        this.elements.retryBtn.addEventListener('click', () => this.retry());

        // Modal events
        this.elements.aboutBtn.addEventListener('click', () => this.showModal());
        this.elements.closeAbout.addEventListener('click', () => this.hideModal());
        this.elements.aboutModal.addEventListener('click', (e) => {
            if (e.target === this.elements.aboutModal) this.hideModal();
        });

        // Share
        this.elements.shareBtn.addEventListener('click', () => this.share());

        // Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') this.hideModal();
        });
    }

    clearChat() {
        this.state.chatHistory = [];
        this.state.messageCount = 0;
        this.state.hasActiveResults = false;
        
        // Reset chat to welcome message
        this.elements.chatMessages.innerHTML = `
            <div class="flex items-start gap-3 mb-4">
                <img src="/images/arti_right.png" alt="Arti" class="w-8 h-8 rounded-full flex-shrink-0">
                <div class="chat-message-arti px-4 py-2.5 max-w-[85%]">
                    <p class="text-sm">
                        Fresh start. What's on your mind?
                    </p>
                </div>
            </div>`;
        
        // Clear other areas
        this.elements.chatInput.value = '';
        this.clearResults();
        
        // Remove any generate plan buttons
        const planBtns = document.querySelectorAll('#generate-plan-container');
        planBtns.forEach(btn => btn.remove());
        
        this.elements.chatInput.focus();
    }

    clearResults() {
        // Clear previous results before showing new ones
        this.elements.accountPlanContainer.innerHTML = '';
        this.elements.accountPlanContainer.classList.add('hidden');
    }

    addChatMessage(content, isUser = false) {
        const messageHtml = isUser ? `
            <div class="flex justify-end mb-4 fade-in">
                <div class="chat-message-user px-4 py-2.5 max-w-[85%] text-sm">
                    ${content}
                </div>
            </div>
        ` : `
            <div class="flex items-start gap-3 mb-4 fade-in">
                <img src="/images/arti_right.png" alt="Arti" class="w-8 h-8 rounded-full flex-shrink-0">
                <div class="chat-message-arti px-4 py-2.5 max-w-[85%]">
                    <div class="text-sm">${marked.parse(content)}</div>
                </div>
            </div>
        `;
        
        this.elements.chatMessages.insertAdjacentHTML('beforeend', messageHtml);
        this.scrollChatToBottom();
    }

    showTypingIndicator() {
        const typingHtml = `
            <div id="typing-indicator" class="flex items-start gap-3 mb-4">
                <img src="/images/arti_right.png" alt="Arti" class="w-8 h-8 rounded-full flex-shrink-0 opacity-50">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        `;
        this.elements.chatMessages.insertAdjacentHTML('beforeend', typingHtml);
        this.scrollChatToBottom();
    }

    hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    showLoading() {
        const message = CONFIG.LOADING_MESSAGES[Math.floor(Math.random() * CONFIG.LOADING_MESSAGES.length)];
        this.elements.loadingMessage.textContent = message;
        this.elements.loadingContainer.classList.remove('hidden');
    }

    hideLoading() {
        this.elements.loadingContainer.classList.add('hidden');
    }

    scrollChatToBottom() {
        const container = document.querySelector('.chat-container');
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }

    // Enhanced chat message handling with auto-plan generation
    async sendChatMessage() {
        const message = this.elements.chatInput.value.trim();
        
        if (this.state.pendingRequest || !message) return;

        // Clear previous results if any
        if (this.state.hasActiveResults) {
            this.clearResults();
        }

        // Add user message
        this.addChatMessage(message, true);
        this.elements.chatInput.value = '';
        this.state.lastQuery = message;
        
        // Update history
        this.state.chatHistory.push({ role: 'user', content: message });
        this.state.messageCount++;

        // Show typing
        this.showTypingIndicator();
        this.state.pendingRequest = true;

        try {
            const response = await this.makeChatRequest(message);
            this.hideTypingIndicator();
            
            const aiMessage = response.message || "Tell me more.";
            this.addChatMessage(aiMessage, false);
            this.state.chatHistory.push({ role: 'assistant', content: aiMessage });
            this.state.lastQuery = '';

            // Auto-generate plan if ready, or show button
            if (response.ready_for_plan) {
                // Auto-generate the plan immediately
                setTimeout(() => {
                    this.generateStrategicPlan();
                }, 1000); // Small delay for better UX
            } else if (response.readiness_score >= 7 && !document.getElementById('generate-plan-container')) {
                // Show button if we have enough context but user hasn't requested it yet
                this.addStrategicPlanButton();
            }

        } catch (error) {
            console.error('Chat request failed:', error);
            this.hideTypingIndicator();
            this.addChatMessage("Connection issues. Try again?", false);
            this.showError();
        } finally {
            this.state.pendingRequest = false;
        }
    }

    async makeChatRequest(message) {
    const contextToSend = this.state.chatHistory.length > 20 
        ? [this.state.chatHistory[0], ...this.state.chatHistory.slice(-19)]
        : this.state.chatHistory;
    
    const response = await fetch(CONFIG.API_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            situation: message,
            mode: 'chat',
            conversationHistory: contextToSend,
            currentDate: new Date().toISOString().split('T')[0] // Always current date
        })
    });

    if (!response.ok) throw new Error('Request failed');
    return await response.json();
}

    // Strategic plan button (replaces confusing suggestion bubbles)
    addStrategicPlanButton() {
        const btnHtml = `
            <div id="generate-plan-container" class="flex justify-center my-4">
                <button onclick="app.generateStrategicPlan()" 
                    class="px-6 py-3 bg-customPurple-500 hover:bg-customPurple-700 text-white font-medium rounded-lg text-sm transition-colors">
                    Generate Strategic Plan
                </button>
            </div>
        `;
        this.elements.chatMessages.insertAdjacentHTML('beforeend', btnHtml);
        this.scrollChatToBottom();
    }

    // Enhanced strategic plan generation
    async generateStrategicPlan() {
        if (this.state.pendingRequest) return;
        
        this.clearResults();
        this.showLoading();
        this.elements.accountPlanContainer.innerHTML = `
            <div class="result-card text-center p-6">
                <div class="loader mx-auto mb-3"></div>
                <p class="text-sm text-gray-600">Creating your strategic plan...</p>
            </div>
        `;
        this.elements.accountPlanContainer.classList.remove('hidden');
        this.elements.accountPlanContainer.scrollIntoView({ behavior: 'smooth' });
        
        this.state.pendingRequest = true;
        
        try {
            const response = await fetch(CONFIG.API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    situation: "Generate strategic plan",
                    mode: 'strategic_plan',
                    conversationHistory: this.state.chatHistory,
                    currentDate: new Date().toISOString().split('T')[0]
                })
            });
            
            if (!response.ok) throw new Error('Request failed');
            
            const data = await response.json();
            this.hideLoading();
            this.state.hasActiveResults = true;
            
            // Display the strategic plan
            this.displayAccountPlan(data);
            
        } catch (error) {
            console.error('Strategic plan generation failed:', error);
            this.hideLoading();
            this.elements.accountPlanContainer.innerHTML = `
                <div class="result-card text-center">
                    <p class="text-red-600 font-medium text-sm mb-3">Couldn't generate your plan.</p>
                    <button onclick="app.generateStrategicPlan()" 
                        class="text-red-700 underline text-sm">Try again</button>
                </div>
            `;
        } finally {
            this.state.pendingRequest = false;
        }
    }

    displayAccountPlan(data) {
        const { 
            account_name = 'Strategic Plan',
            executive_summary = '',
            next_steps = [],
            strategic_assessment = {},
            stakeholder_strategy = [],
            communication_framework = {},
            top_contractors = [],
            technology_plays = [],
            market_intelligence = {},
            strategic_diagram
        } = data;
        
        let html = `
            <div class="account-plan-header">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">${account_name}</h2>
                        <p class="text-sm text-gray-600">Strategic Analysis & Recommendations</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="app.copyAccountPlan()" 
                            class="p-2 text-gray-600 hover:text-gray-800 hover:bg-white/50 rounded-lg transition-colors" 
                            title="Copy">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                            </svg>
                        </button>
                        <button onclick="window.print()" 
                            class="p-2 text-gray-600 hover:text-gray-800 hover:bg-white/50 rounded-lg transition-colors" 
                            title="Print">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            ${executive_summary ? `
                <div class="result-card bg-customPurple-50 border-customPurple-200">
                    <h3>Executive Summary</h3>
                    <p>${executive_summary}</p>
                </div>
            ` : ''}

            ${strategic_assessment && Object.keys(strategic_assessment).length > 0 ? `
                <div class="result-card">
                    <h3>Strategic Assessment</h3>
                    ${strategic_assessment.current_state ? `
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Current State</h4>
                            <p class="text-sm">${strategic_assessment.current_state}</p>
                        </div>
                    ` : ''}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${strategic_assessment.key_challenges ? `
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-2">Key Challenges</h4>
                                <ul class="space-y-1">
                                    ${strategic_assessment.key_challenges.map(c => `
                                        <li class="flex items-start gap-2">
                                            <span class="text-red-500 mt-1 text-xs">▪</span>
                                            <span class="text-sm">${c}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${strategic_assessment.opportunities ? `
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-2">Strategic Opportunities</h4>
                                <ul class="space-y-1">
                                    ${strategic_assessment.opportunities.map(o => `
                                        <li class="flex items-start gap-2">
                                            <span class="text-green-500 mt-1 text-xs">▪</span>
                                            <span class="text-sm">${o}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : ''}

            ${next_steps && next_steps.length > 0 ? `
                <div class="result-card">
                    <h3>Strategic Next Steps</h3>
                    <div class="space-y-4">
                        ${next_steps.map((step, i) => `
                            <div class="border-l-4 ${
                                step.priority === 'immediate' ? 'border-red-500 bg-red-50' :
                                step.priority === 'high' ? 'border-orange-500 bg-orange-50' :
                                'border-blue-500 bg-blue-50'
                            } pl-4 py-3">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-semibold text-gray-900">${step.action}</h4>
                                    <span class="text-xs font-medium px-2 py-1 rounded ${
                                        step.priority === 'immediate' ? 'bg-red-100 text-red-800' :
                                        step.priority === 'high' ? 'bg-orange-100 text-orange-800' :
                                        'bg-blue-100 text-blue-800'
                                    }">${step.priority} • ${step.timeline}</span>
                                </div>
                                <p class="text-sm text-gray-700">${step.rationale}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}

            ${market_intelligence && Object.keys(market_intelligence).length > 0 ? `
                <div class="result-card">
                    <h3>Market Intelligence</h3>
                    ${market_intelligence.market_size ? `<p class="text-sm mb-3"><strong>Market Size:</strong> ${market_intelligence.market_size}</p>` : ''}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${market_intelligence.key_trends ? `
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-2">Key Market Trends</h4>
                                <ul class="space-y-1">
                                    ${market_intelligence.key_trends.map(t => `<li class="text-sm">• ${t}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${market_intelligence.procurement_landscape ? `
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-2">Procurement Landscape</h4>
                                <p class="text-sm">${market_intelligence.procurement_landscape}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : ''}

            ${top_contractors && top_contractors.length > 0 ? `
                <div class="result-card">
                    <h3>Key Contractors & Partners</h3>
                    <div class="space-y-3">
                        ${top_contractors.map(contractor => `
                            <div class="border border-gray-200 rounded-lg p-3">
                                <h4 class="font-semibold text-gray-900">${contractor.name}</h4>
                                <p class="text-sm text-gray-600 mb-2">${contractor.strength}</p>
                                <p class="text-sm"><strong>Engagement Opportunity:</strong> ${contractor.opportunity}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}

            ${technology_plays && technology_plays.length > 0 ? `
                <div class="result-card">
                    <h3>Technology Landscape</h3>
                    <div class="space-y-3">
                        ${technology_plays.map(tech => `
                            <div class="border border-gray-200 rounded-lg p-3">
                                <h4 class="font-semibold text-gray-900">${tech.technology}</h4>
                                <p class="text-sm text-gray-600 mb-2">${tech.federal_adoption}</p>
                                <p class="text-sm"><strong>Your Positioning:</strong> ${tech.opportunity}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}

            ${stakeholder_strategy && stakeholder_strategy.length > 0 ? `
                <div class="result-card">
                    <h3>Stakeholder Strategy</h3>
                    <div class="space-y-4">
                        ${stakeholder_strategy.map(group => `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-900 mb-2">${group.stakeholder_group}</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <strong>Approach:</strong> ${group.approach}
                                    </div>
                                    <div>
                                        <strong>Key Messages:</strong> ${group.key_messages}
                                    </div>
                                </div>
                                ${group.success_metrics ? `
                                    <div class="mt-2 text-sm">
                                        <strong>Success Metrics:</strong> ${group.success_metrics}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}

            ${communication_framework && Object.keys(communication_framework).length > 0 ? `
                <div class="result-card">
                    <h3>Communication Framework</h3>
                    ${communication_framework.key_messages ? `
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Key Messages</h4>
                            <ul class="space-y-1">
                                ${communication_framework.key_messages.map(msg => `
                                    <li class="text-sm">• ${msg}</li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${communication_framework.email_template ? `
                        <div>
                            <h4 class="font-semibold text-gray-800 mb-2">Email Template</h4>
                            <div class="bg-gray-50 rounded-lg p-3 text-xs font-mono whitespace-pre-wrap border border-gray-200">${communication_framework.email_template}</div>
                        </div>
                    ` : ''}
                </div>
            ` : ''}

            ${strategic_diagram && strategic_diagram.trim() ? `
                <div class="result-card" id="strategic-chart-container">
                    <h3>Strategic Framework</h3>
                    <div class="mermaid-container">
                        <div id="mermaid-diagram" class="mermaid">
                            ${strategic_diagram}
                        </div>
                    </div>
                </div>
            ` : ''}
        `;
        
        this.elements.accountPlanContainer.innerHTML = html;
        
        if (strategic_diagram && strategic_diagram.trim()) {
            this.renderMermaidChart();
        }
    }
    
    copyAccountPlan() {
        const content = this.elements.accountPlanContainer.innerText;
        
        if (!content) {
            alert('No plan to copy');
            return;
        }
        
        navigator.clipboard.writeText(content)
            .then(() => {
                alert('Strategic plan copied!');
            })
            .catch(() => alert('Copy failed. Please try selecting and copying manually.'));
    }

    // Updated chart rendering - no fallbacks, just hide on failure
    renderMermaidChart() {
        setTimeout(async () => {
            try {
                const mermaidElement = document.querySelector('#mermaid-diagram');
                if (!mermaidElement || !mermaidElement.textContent.trim()) {
                    this.hideMermaidContainer();
                    return;
                }

                // Clean the mermaid syntax but don't replace with fallbacks
                let mermaidCode = this.cleanMermaidSyntax(mermaidElement.textContent.trim());
                
                // Update the element with cleaned code
                mermaidElement.textContent = mermaidCode;
                
                // Try to render the AI-generated chart
                await mermaid.run();
                
                // Check if rendering actually worked
                const svgElement = mermaidElement.querySelector('svg');
                if (!svgElement || svgElement.children.length === 0) {
                    throw new Error('Mermaid rendering failed');
                }
                
            } catch (error) {
                console.error('AI-generated chart failed to render:', error);
                // No fallback - just hide the entire chart section
                this.hideMermaidContainer();
            }
        }, 100);
    }

    cleanMermaidSyntax(mermaidCode) {
        // Only clean syntax issues, don't replace content
        return mermaidCode
            .replace(/[""]/g, '"')  // Fix smart quotes
            .replace(/['']/g, "'")  // Fix smart apostrophes
            .replace(/[–—]/g, '-')  // Fix em/en dashes
            .replace(/\\n/g, '\n')  // Fix escaped newlines
            .replace(/\n\s*\n/g, '\n')  // Remove empty lines
            .trim();
    }

    hideMermaidContainer() {
        const container = document.querySelector('.result-card:has(#mermaid-diagram)') || 
                         document.querySelector('#mermaid-diagram')?.closest('.result-card');
        if (container) {
            container.style.display = 'none';
        }
    }

    share() {
        const shareData = {
            title: 'AskArti',
            text: 'Federal sales advice that actually works',
            url: 'https://askarti.com'
        };
        
        if (navigator.share) {
            navigator.share(shareData).catch(console.error);
        } else {
            navigator.clipboard.writeText(`${shareData.text} - ${shareData.url}`)
                .then(() => {
                    this.elements.shareBtn.textContent = 'Link Copied!';
                    setTimeout(() => this.elements.shareBtn.textContent = 'Share', 2000);
                })
                .catch(() => alert('Please copy: https://askarti.com'));
        }
    }

    showError() {
        this.elements.errorMessage.classList.remove('hidden');
        setTimeout(() => {
            this.elements.errorMessage.classList.add('hidden');
        }, 5000);
    }

    retry() {
        this.elements.errorMessage.classList.add('hidden');
        if (this.state.lastQuery) {
            this.elements.chatInput.value = this.state.lastQuery;
            this.sendChatMessage();
        }
    }

    showModal() {
        this.elements.aboutModal.classList.remove('hidden');
    }

    hideModal() {
        this.elements.aboutModal.classList.add('hidden');
    }
}

// Initialize
const app = new AskArti();
</script>
</body>
</html>