<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AskArti - Your Fed Sales Therapist</title>
    
    <!-- Meta Tags -->
    <meta name="description" content="When your boss wants impossible quota, your customer ghosts you, and your stakeholders vanish - Arti gets it. Real federal sales advice from someone who's been in the trenches.">
    <meta name="keywords" content="federal sales, government sales, deal therapy, sales burnout, govcon, sales advice">
    <meta name="author" content="Mark">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://askarti.com">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://askarti.com/">
    <meta property="og:title" content="AskArti - Your Federal Sales Therapist">
    <meta property="og:description" content="When federal sales is breaking you down, Arti builds you back up. No BS. No buzzwords. Just real talk.">
    <meta property="og:image" content="https://askarti.com/images/asklite.png">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:url" content="https://askarti.com/">
    <meta name="twitter:title" content="AskArti - Your Federal Sales Therapist">
    <meta name="twitter:description" content="Real federal sales advice from someone who gets it.">
    <meta name="twitter:image" content="https://askarti.com/images/asklite.png">
    
    <!-- Favicons -->
    <link rel="icon" href="/images/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#7C6BBE">
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Preload critical assets -->
    <link rel="preload" href="/images/asklite.png" as="image">
    <link rel="preload" href="/images/arti_right.png" as="image">
    
    <!-- Styles and Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WLGEPY5H4G"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-WLGEPY5H4G');
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7C6BBE',
                        customPurple: {
                            100: '#E8E4F7',
                            200: '#D8D2EF',
                            500: '#7C6BBE',
                            700: '#5A4E8C',
                            900: '#403866'
                        },
                        accountBlue: {
                            100: '#E6F0F9',
                            500: '#4A77B3',
                            700: '#345C96'
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'bounce-slow': 'bounce 3s infinite'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-20px)' }
                        },
                        slideIn: {
                            '0%': { transform: 'translateX(-100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>
    
<style>
    body {
        font-family: 'Inter', sans-serif;
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        min-height: 100vh;
    }

    /* Enhanced loader */
    .loader {
        border: 3px solid #e5e7eb;
        border-top: 3px solid #7C6BBE;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
    }

    .loader-text {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Chat bubbles with personality */
    .chat-message-user {
        background: linear-gradient(135deg, #7C6BBE 0%, #5A4E8C 100%);
        color: white;
        position: relative;
        box-shadow: 0 2px 10px rgba(124, 107, 190, 0.3);
    }

    .chat-message-user::after {
        content: '';
        position: absolute;
        right: -8px;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid #5A4E8C;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
    }

    .chat-message-arti {
        background: white;
        color: #1f2937;
        border: 1px solid #e5e7eb;
        position: relative;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .chat-message-arti::after {
        content: '';
        position: absolute;
        left: -8px;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-right: 8px solid white;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
    }

    /* Therapy session vibes */
    .therapy-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(124, 107, 190, 0.1);
        transition: all 0.3s ease;
    }

    .therapy-card:hover {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        transform: translateY(-2px);
    }

    /* Typing indicator with personality */
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 16px 20px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .typing-dot {
        width: 10px;
        height: 10px;
        background: linear-gradient(135deg, #7C6BBE 0%, #5A4E8C 100%);
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    .typing-dot:nth-child(3) { animation-delay: 0s; }

    @keyframes typing {
        0%, 80%, 100% {
            transform: scale(0.8);
            opacity: 0.5;
        }
        40% {
            transform: scale(1.2);
            opacity: 1;
        }
    }

    /* Enhanced mermaid container */
    .mermaid-container {
        text-align: center;
        min-height: 200px;
        position: relative;
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        border-radius: 0.75rem;
        padding: 1rem;
    }

    /* Sponsor ad with personality */
    .sponsor-ad {
        background: linear-gradient(135deg, rgba(124, 107, 190, 0.05), rgba(124, 107, 190, 0.02));
        border: 2px dashed rgba(124, 107, 190, 0.2);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .sponsor-ad::before {
        content: '💸';
        position: absolute;
        top: -20px;
        right: -20px;
        font-size: 60px;
        opacity: 0.1;
        transform: rotate(-15deg);
    }

    .sponsor-ad:hover {
        background: linear-gradient(135deg, rgba(124, 107, 190, 0.08), rgba(124, 107, 190, 0.04));
        border-color: rgba(124, 107, 190, 0.3);
        transform: translateY(-1px);
    }

    /* Mobile optimizations */
    @media (max-width: 640px) {
        .chat-container {
            height: 50dvh;
            max-height: 400px;
        }

        .therapy-card {
            padding: 1rem;
        }

        input[type="text"],
        input[type="email"],
        textarea {
            font-size: 16px !important;
        }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        body {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: #f9fafb;
        }

        .therapy-card {
            background: #374151;
            border-color: rgba(124, 107, 190, 0.3);
        }

        .chat-message-arti {
            background: #374151;
            color: #f9fafb;
            border-color: #4b5563;
        }
    }

	/* --- UNIFIED CARD TYPOGRAPHY --- */
.therapy-card h3 {
    font-size: 1.1rem; /* 17.6px */
    font-weight: 800; /* Extra-bold for clear headings */
    color: #1f2937;
}

.therapy-card p, 
.therapy-card li, 
.therapy-card td,
.therapy-card .prose {
    font-size: 0.9rem; /* 14.4px */
    line-height: 1.65;
    color: #374151; /* A standard, readable text color */
}

/* Ensure prose styles don't override the base therapy-card styles */
.therapy-card .prose p, 
.therapy-card .prose li {
    font-size: inherit;
    line-height: inherit;
    color: inherit;
}

.therapy-card strong {
    color: #111827; /* Make bolded text stand out */
    font-weight: 700;
}

/* CRM-style table styling */
.crm-table {
    width: 100%;
    border-collapse: collapse;
}

.crm-table th,
.crm-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
}

.crm-table th {
    background-color: #f9fafb;
    font-weight: 600;
    color: #374151;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
}

.crm-section {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 16px;
}

.crm-header {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 24px;
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.status-high { background-color: #fef2f2; color: #991b1b; }
.status-medium { background-color: #fefce8; color: #92400e; }
.status-low { background-color: #f0fdf4; color: #166534; }
.status-champion { background-color: #ecfdf5; color: #047857; }
.status-neutral { background-color: #f8fafc; color: #475569; }
.status-blocker { background-color: #fef2f2; color: #dc2626; }
</style>

</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 text-gray-900 min-h-screen">
    <div class="max-w-screen-lg mx-auto px-4 sm:px-6 lg:px-8 pt-8 pb-20">
        <!-- Header with personality -->
        <header class="text-center mb-6 animate-fade-in">
            <a href="/" aria-label="AskArti Home" class="inline-block group">
                <img src="/images/asklite.png" alt="AskArti" class="h-16 w-auto md:h-20 lg:h-24 transition-transform group-hover:scale-105">
            </a>
            <p class="mt-2 text-sm text-gray-600 font-medium">
                <span id="greeting-text" class="transition-all">Your Federal Sales Therapist</span>
            </p>
        </header>

        <main class="therapy-card mb-6 animate-slide-in">
            <!-- Unified chat interface -->
            <div id="chat-interface">
                <div class="chat-container h-[60vh] sm:h-96 max-h-[500px] overflow-y-auto mb-4 rounded-xl p-4 sm:p-6 transition-all bg-gradient-to-br from-gray-50 to-slate-100" id="chat-container">
                    <div id="chat-messages" class="space-y-4">
                        <!-- Welcome message with more personality -->
                        <div class="flex items-start gap-3">
                           <img src="/images/arti_right.png" alt="Arti" class="w-10 h-10 rounded-full animate-bounce-slow">
                            <div class="chat-message-arti rounded-2xl px-4 py-3 max-w-[85%] animate-fade-in">
                                <p class="text-gray-800 text-sm sm:text-base leading-relaxed">
                                    <strong>Hey there.</strong> I'm Arti. I've been where you are - 
                                    impossible quotas, vanishing stakeholders, and customers who treat your emails like spam. 
                                    <br><br>
                                    <em>What's got you pulling your hair out today?</em> 
                                    <span class="text-gray-500 text-xs block mt-2">Tell me what's really going on...</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="plan-button-container" class="hidden animate-fade-in p-4 border-t border-gray-200">
                    <button id="generate-plan-btn" onclick="app.generateAccountPlan()"
                            class="w-full bg-gradient-to-r from-accountBlue-500 to-accountBlue-700 hover:from-accountBlue-600 hover:to-accountBlue-800 text-white font-bold px-6 py-3 rounded-xl text-sm flex items-center justify-center gap-2 transition-all transform hover:scale-105 shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        Generate Strategic Account Plan
                    </button>
                </div>

                <!-- Input area with therapy vibes -->
                <div class="flex gap-2 sticky bottom-0 bg-white/80 backdrop-blur-sm pt-3 z-10 rounded-xl">
                    <button 
                        id="clear-chat-btn"
                        class="p-2.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all group"
                        title="Start fresh">
                        <svg class="w-5 h-5 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                    <input 
                        type="text" 
                        id="chat-input"
                        inputmode="text"
                        autocomplete="off"
                        autocorrect="on"
                        autocapitalize="sentences"
                        spellcheck="true"
                        class="flex-1 p-3 text-[16px] sm:text-base border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary min-h-[44px] transition-all hover:border-gray-300"
                        placeholder="Tell me what's really going on..."
                        maxlength="500">
                    <button 
                        id="chat-send-btn" 
                        class="bg-gradient-to-r from-customPurple-500 to-customPurple-700 hover:from-customPurple-600 hover:to-customPurple-800 text-white font-medium px-4 sm:px-6 py-3 rounded-xl transition-all text-sm sm:text-base min-h-[44px] whitespace-nowrap transform hover:scale-105 active:scale-95">
                        <span class="flex items-center gap-2">
                            <span>Send</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </span>
                    </button>
                </div>
            </div>
        </main>

        <!-- Loading with personality -->
        <div id="loading-message-container" class="text-center py-4 hidden">
            <div class="inline-flex items-center gap-3 bg-white px-6 py-3 rounded-full shadow-lg">
                <div class="loader"></div>
                <p id="loading-message" class="text-gray-700 font-medium loader-text"></p>
            </div>
        </div>

        <!-- Error with empathy -->
        <div id="error-message" class="bg-gradient-to-r from-red-50 to-pink-50 border-2 border-red-200 rounded-xl p-6 text-center mb-4 hidden">
            <p class="text-red-700 font-bold mb-2 text-lg">Oof. Technical Difficulties.</p>
            <p class="text-red-600 text-sm" id="error-details">Even my servers need therapy sometimes. Let's try this again.</p>
            <button id="retry-btn" class="mt-4 bg-red-100 hover:bg-red-200 text-red-700 font-medium py-2 px-6 rounded-lg text-sm transition-all transform hover:scale-105">
                Deep Breath & Retry
            </button>
        </div>

        <!-- Results container -->
        <div id="results-container"></div>
        
        <!-- Account Plan Results -->
        <div id="account-plan-container" class="hidden mt-6 space-y-4"></div>

        <!-- Footer with personality -->
        <footer class="text-center mt-12 space-y-4 pb-20">
            <div class="flex justify-center gap-6 text-sm">
                <button id="about-btn" class="text-customPurple-500 hover:text-customPurple-700 font-medium transition-all hover:underline">About Arti</button>
                <button id="share-btn" class="text-customPurple-500 hover:text-customPurple-700 font-medium transition-all hover:underline">Share the Therapy</button>
                <a href="mailto:mark@subhoo.com" class="text-customPurple-500 hover:text-customPurple-700 font-medium transition-all hover:underline">Talk to a Human</a>
            </div>

            <!-- Sponsor ad with more personality -->
            <div class="sponsor-ad rounded-xl p-4 mb-4 text-sm bg-white border-2 border-dashed not-italic text-left leading-relaxed">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xs font-bold text-gray-600 bg-gradient-to-r from-yellow-200 to-amber-200 px-3 py-1 rounded-full uppercase">Sponsor Therapy</span>
                    <span class="text-gray-800 font-bold">Hey, stressed seller!</span>
                </div>
                <p class="text-sm leading-relaxed text-gray-700">
                    Every time you vent to Arti, I'm paying for the therapy session. My AWS bill is starting to look like your Q4 quota - 
                    <strong>completely unrealistic</strong>. 
                </p>
                <p class="mt-2 text-xs italic text-gray-600">
                    Help me help you. Sponsor this spot for just $99/mo. 
                    <br>That's like 2 overpriced airport drinks. Worth it.
                </p>
                <p class="mt-3 text-sm text-customPurple-600 font-bold">
                    <a href="mailto:mark@subhoo.com" class="hover:underline">
                        Save my sanity (and Lambda bill) →
                    </a>
                </p>
            </div>

            <p class="text-xs text-gray-500 max-w-2xl mx-auto leading-relaxed">
                <strong>Therapy Disclaimer:</strong> AskArti provides emotional support and strategic advice for federal sales professionals. 
                Not a replacement for actual therapy (though sometimes it feels like you need both). 
                AI-powered insights may occasionally hallucinate - just like your quota.
            </p>

            <p class="text-xs text-gray-400 font-medium">
                © 2025 AskArti · Built by sellers who've been burned · For sellers currently on fire 🔥
            </p>
        </footer>
    </div>

    <!-- Enhanced About Modal -->
    <div id="about-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 modal-content transform transition-all">
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center gap-3">
                    <img src="images/oldmark.jpg" alt="Mark Flournoy" class="w-14 h-14 rounded-full object-cover border-3 border-customPurple-200 animate-float">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">Hey, I'm Mark</h2>
                        <p class="text-xs text-gray-600">Fellow Fed Sales Survivor</p>
                    </div>
                </div>
                <button id="close-about" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4 text-gray-700">
                <p class="leading-relaxed">
                    I built AskArti after too many nights staring at the ceiling, wondering why my champion went dark 
                    and whether I'd hit my impossible quota.
                </p>
                <p class="leading-relaxed">
                    Sound familiar? Yeah, I thought so.
                </p>
                <p class="text-sm leading-relaxed">
                    Arti's not perfect (what in federal sales is?), but he's here 24/7 when you need to vent, 
                    strategize, or just remember that you're not losing your mind - federal sales is just Like That™.
                </p>
                
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 text-sm">
                        <h3 class="font-semibold text-gray-800 mb-2 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-customPurple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                            Your Data = Your Business
                        </h3>
                        <p class="text-gray-600 mb-2">
                            Zero storage. Zero tracking. Zero BS. 
                            Everything happens in-memory and vanishes faster than your stakeholder's promises. 
                            The AI models (Gemini, Claude, GPT) might learn from our chats, but I don't keep anything.
                        </p>
                    </div>
                </div>
                
                <div class="pt-4">
                    <a href="https://calendly.com/markflournoy/30min" target="_blank" 
                       class="block w-full bg-gradient-to-r from-customPurple-500 to-customPurple-700 hover:from-customPurple-600 hover:to-customPurple-800 text-white font-bold py-3 px-4 rounded-xl text-center transition-all transform hover:scale-105">
                        Let's Commiserate Over Coffee ☕ →
                    </a>
                    <p class="text-xs text-center text-gray-500 mt-2">
                        Virtual coffee. Real federal sales talk.
                    </p>
                </div>
            </div>
        </div>
    </div>

<script>
// Configuration with personality
const CONFIG = {
   API_ENDPOINT: 'https://vd823jgh0a.execute-api.us-east-1.amazonaws.com/prod/AskArtiAPI',
   REQUEST_TIMEOUT: 25000,
   MAX_RETRIES: 2,
   RETRY_DELAY: 2000,
   MAX_INPUT_LENGTH: 500,
   MIN_REQUEST_INTERVAL: 2000,
   LOADING_MESSAGES: [
       "Reading between the lines...",
       "Channeling my inner COTR...",
       "Consulting the Federal Acquisition Regulation...",
       "Calculating your actual close probability...",
       "Finding the real decision maker...",
       "Translating government speak...",
       "Brewing strong coffee...",
       "Reviewing similar train wrecks...",
       "Activating empathy mode..."
   ]
};

// Enhanced Application class
class AskArti {
   constructor() {
       this.elements = this.getElements();
       this.state = {
           pendingRequest: false,
           lastRequestTime: 0,
           loadingInterval: null,
           abortController: null,
           lastQuery: '',
           chatHistory: [],
           messageCount: 0,
           sessionStart: Date.now()
       };
       this.init();
   }

   getElements() {
       return {
           chatMessages: document.getElementById('chat-messages'),
           chatInput: document.getElementById('chat-input'),
           chatSendBtn: document.getElementById('chat-send-btn'),
           clearChatBtn: document.getElementById('clear-chat-btn'),
           loadingMessageContainer: document.getElementById('loading-message-container'),
           loadingMessage: document.getElementById('loading-message'),
           errorMessage: document.getElementById('error-message'),
           errorDetails: document.getElementById('error-details'),
           retryBtn: document.getElementById('retry-btn'),
           resultsContainer: document.getElementById('results-container'),
           accountPlanContainer: document.getElementById('account-plan-container'),
           aboutBtn: document.getElementById('about-btn'),
           aboutModal: document.getElementById('about-modal'),
           closeAbout: document.getElementById('close-about'),
           shareBtn: document.getElementById('share-btn'),
           greetingText: document.getElementById('greeting-text'),
           chatContainer: document.getElementById('chat-container')
       };
   }

   init() {
       this.initializeMermaid();
       this.setupEventListeners();
       this.updateGreeting();
       this.elements.chatInput.focus();
   }

   updateGreeting() {
       const hour = new Date().getHours();
       const day = new Date().getDay();
       
       let greeting;
       if (day === 0 || day === 6) {
           greeting = "No rest for the quota-crushed?";
       } else if (hour < 12) {
           greeting = "Rough morning already?";
       } else if (hour < 17) {
           greeting = "Afternoon crisis mode?";
       } else if (hour < 21) {
           greeting = "Still at it? Respect.";
       } else {
           greeting = "Burning the midnight oil?";
       }
       
       this.elements.greetingText.textContent = greeting;
   }

   initializeMermaid() {
       mermaid.initialize({ 
           startOnLoad: false,
           securityLevel: 'strict',
           theme: 'default',
           flowchart: {
               htmlLabels: true,
               curve: 'basis'
           }
       });
   }

   setupEventListeners() {
       // Chat events
       this.elements.chatSendBtn.addEventListener('click', () => this.sendChatMessage());
       this.elements.chatInput.addEventListener('keydown', (e) => {
           if (e.key === 'Enter' && !e.shiftKey) {
               e.preventDefault();
               this.sendChatMessage();
           }
       });

       this.elements.chatInput.addEventListener('input', (e) => {
           if (this.elements.chatSendBtn.querySelector('.retry-icon')) {
               this.resetSendButton();
           }
       });

       // Clear chat with confirmation
       this.elements.clearChatBtn.addEventListener('click', () => {
           if (this.state.messageCount > 2) {
               if (confirm('Start fresh? (Your current therapy session will be erased)')) {
                   this.clearChat();
               }
           } else {
               this.clearChat();
           }
       });

       // Retry
       this.elements.retryBtn.addEventListener('click', () => {
           this.elements.errorMessage.classList.add('hidden');
           if (this.state.lastQuery) {
               this.sendChatMessage();
           }
       });

       // Share
       this.elements.shareBtn.addEventListener('click', () => this.share());

       // About modal
       this.elements.aboutBtn.addEventListener('click', () => this.showModal());
       this.elements.closeAbout.addEventListener('click', () => this.hideModal());
       this.elements.aboutModal.addEventListener('click', (e) => {
           if (e.target === this.elements.aboutModal) this.hideModal();
       });

       // Escape key
       document.addEventListener('keydown', (e) => {
           if (e.key === 'Escape') this.hideModal();
       });
   }

   clearChat() {
       // Reset everything
       this.state.chatHistory = [];
       this.state.messageCount = 0;
       
       // Reset UI
       this.updateGreeting();
       
       // Clear messages but keep welcome
       this.elements.chatMessages.innerHTML = `
           <div class="flex items-start gap-3">
               <img src="/images/arti_right.png" alt="Arti" class="w-10 h-10 rounded-full animate-bounce-slow">
               <div class="chat-message-arti rounded-2xl px-4 py-3 max-w-[85%] animate-fade-in">
                   <p class="text-gray-800 text-sm sm:text-base leading-relaxed">
                       <strong>Fresh start.</strong> Sometimes that's exactly what we need.
                       <br><br>
                       <em>What's on your mind?</em>
                   </p>
               </div>
           </div>`;
       
       // Clear other elements
       this.elements.chatInput.value = '';
       this.elements.resultsContainer.innerHTML = '';
       this.elements.accountPlanContainer.classList.add('hidden');
       this.elements.accountPlanContainer.innerHTML = '';
       document.getElementById('plan-button-container').classList.add('hidden'); 
       
       this.elements.chatInput.focus();
       this.showTemporaryMessage('Clean slate. Let\'s go.', 'info');
   }

   addChatMessage(content, isUser = false) {
       const messageHtml = isUser ? `
           <div class="flex justify-end animate-slide-in">
               <div class="chat-message-user rounded-2xl px-4 py-3 max-w-[85%] shadow-lg">
                   ${content}
               </div>
           </div>
       ` : `
           <div class="flex items-start gap-3 animate-slide-in">
               <img src="/images/arti_right.png" alt="Arti" class="w-10 h-10 rounded-full">
               <div class="chat-message-arti rounded-2xl px-4 py-3 max-w-[85%]">
                   ${marked.parse(content)}
               </div>
           </div>
       `;
       
       this.elements.chatMessages.insertAdjacentHTML('beforeend', messageHtml);
       this.scrollChatToBottom();
   }

   showTypingIndicator() {
       const typingHtml = `
           <div id="typing-indicator" class="flex items-start gap-3 animate-fade-in">
               <img src="/images/arti_right.png" alt="Arti" class="w-10 h-10 rounded-full opacity-50">
               <div class="typing-indicator">
                   <div class="typing-dot"></div>
                   <div class="typing-dot"></div>
                   <div class="typing-dot"></div>
               </div>
           </div>
       `;
       this.elements.chatMessages.insertAdjacentHTML('beforeend', typingHtml);
       this.scrollChatToBottom();
   }

   hideTypingIndicator() {
       const indicator = document.getElementById('typing-indicator');
       if (indicator) indicator.remove();
   }

   showLoadingMessage() {
       const message = CONFIG.LOADING_MESSAGES[Math.floor(Math.random() * CONFIG.LOADING_MESSAGES.length)];
       this.elements.loadingMessage.textContent = message;
       this.elements.loadingMessageContainer.classList.remove('hidden');
   }

   hideLoadingMessage() {
       this.elements.loadingMessageContainer.classList.add('hidden');
   }

   scrollChatToBottom() {
       const scrollContainer = document.querySelector('.chat-container');
       if (!scrollContainer) return;

       requestAnimationFrame(() => {
           scrollContainer.scrollTop = scrollContainer.scrollHeight;
           setTimeout(() => {
               scrollContainer.scrollTop = scrollContainer.scrollHeight;
           }, 100);
       });
   }

   async sendChatMessage() {
       const message = this.elements.chatInput.value.trim();
       
       if (this.state.pendingRequest) return;
       
       if (!message && this.state.lastQuery) {
           this.retryLastMessage();
           return;
       }
       
       if (!message) return;

       // Add user message to chat
       this.addChatMessage(message, true);
       this.elements.chatInput.value = '';
       this.state.lastQuery = message;
       
       // Add to chat history
       this.state.chatHistory.push({ role: 'user', content: message });
       this.state.messageCount++;

       // Show typing indicator
       this.showTypingIndicator();
       this.showLoadingMessage();
       this.state.pendingRequest = true;

       try {
           const response = await this.makeChatRequest(message);
           this.hideTypingIndicator();
           this.hideLoadingMessage();
           
           // Check if this is a factual answer
           if (response.response_type === 'factual_answer' && response.answer) {
               // Format the factual answer nicely
               const formattedAnswer = `**Here's what I know:**\n\n${response.answer}`;
               this.addChatMessage(formattedAnswer, false);
               this.state.chatHistory.push({ role: 'assistant', content: formattedAnswer });
           } else {
               // Add Arti's response
               this.addChatMessage(response.message || "I hear you. Tell me more about what's happening.", false);
               this.state.chatHistory.push({ role: 'assistant', content: response.message });
           }

           // Clear lastQuery on success
           this.state.lastQuery = '';

           // Show the plan generation button if enough context is built
           if (this.state.messageCount >= 3 && document.getElementById('plan-button-container')?.classList.contains('hidden')) {
               document.getElementById('plan-button-container').classList.remove('hidden');
           }

       } catch (error) {
           console.error('Chat request failed:', error);
           this.hideTypingIndicator();
           this.hideLoadingMessage();
           this.addChatMessage("Connection issues. Even my servers are ghosting me now. Try again?", false);
           
           // Update send button for retry
           this.elements.chatSendBtn.innerHTML = `
               <span class="flex items-center gap-2">
                   <svg class="w-5 h-5 retry-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                   </svg>
                   <span>Retry</span>
               </span>
           `;
           this.elements.chatSendBtn.classList.add('bg-gradient-to-r', 'from-yellow-500', 'to-amber-600');
       } finally {
           this.state.pendingRequest = false;
       }
   }

   resetSendButton() {
       this.elements.chatSendBtn.innerHTML = `
           <span class="flex items-center gap-2">
               <span>Send</span>
               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
               </svg>
           </span>
       `;
       this.elements.chatSendBtn.className = 'bg-gradient-to-r from-customPurple-500 to-customPurple-700 hover:from-customPurple-600 hover:to-customPurple-800 text-white font-medium px-4 sm:px-6 py-3 rounded-xl transition-all text-sm sm:text-base min-h-[44px] whitespace-nowrap transform hover:scale-105 active:scale-95';
   }

   async makeChatRequest(message) {
       const contextToSend = this.state.chatHistory.length > 20 
           ? [this.state.chatHistory[0], ...this.state.chatHistory.slice(-19)]
           : this.state.chatHistory;
       
       try {
           const response = await fetch(CONFIG.API_ENDPOINT, {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ 
                   situation: message,
                   mode: 'chat',
                   conversationHistory: contextToSend,
                   currentDate: new Date().toISOString().split('T')[0],
                   sessionDuration: Math.floor((Date.now() - this.state.sessionStart) / 1000)
               })
           });

           if (!response.ok) throw new Error('Request failed');
           return await response.json();
       } catch (error) {
           console.error('API request failed:', error);
           throw error;
       }
   }

   async generateAccountPlan() {
       if (this.state.pendingRequest) return;
       document.getElementById('plan-button-container').classList.add('hidden');
       this.elements.resultsContainer.innerHTML = '';
       
       // Show loading
       this.showTemporaryMessage('Crafting your CRM-style account plan...', 'info');
       this.elements.accountPlanContainer.innerHTML = `
           <div class="therapy-card text-center p-8 animate-pulse-slow">
               <div class="loader mx-auto mb-4"></div>
               <p class="text-lg font-medium text-gray-700">Building your strategic account plan...</p>
               <p class="text-sm text-gray-500 mt-2">This is going to be good.</p>
           </div>
       `;
       this.elements.accountPlanContainer.classList.remove('hidden');
       
       // Smooth scroll
       this.elements.accountPlanContainer.scrollIntoView({ behavior: 'smooth' });
       
       this.state.pendingRequest = true;
       try {
           let contextToSend = this.state.chatHistory;
           const maxContextSize = 20;
           if (contextToSend.length > maxContextSize) {
               contextToSend = [
                   contextToSend[0],
                   ...contextToSend.slice(-maxContextSize + 1)
               ];
           }
           
           const response = await fetch(CONFIG.API_ENDPOINT, {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ 
                   situation: "Generate account plan",
                   mode: 'account_plan',
                   conversationHistory: contextToSend,
                   currentDate: new Date().toISOString().split('T')[0]
               })
           });
           
           if (!response.ok) throw new Error('Request failed');
           
           const data = await response.json();
           this.displayCRMAccountPlan(data);
           
           this.showTemporaryMessage("Account plan generated! Time to execute.", 'info');
           
       } catch (error) {
           console.error('Account plan generation failed:', error);
           this.elements.accountPlanContainer.innerHTML = `
               <div class="therapy-card text-center p-6">
                   <p class="text-red-600 mb-3 font-medium">Plan generation hit a snag.</p>
                   <p class="text-gray-600 text-sm mb-4">Even my AI needs a coffee break sometimes.</p>
                   <button onclick="app.generateAccountPlan()" class="bg-gradient-to-r from-red-100 to-pink-100 hover:from-red-200 hover:to-pink-200 text-red-700 font-medium py-2 px-6 rounded-xl text-sm transition-all transform hover:scale-105">
                       Try Again
                   </button>
               </div>
           `;
       } finally {
           this.state.pendingRequest = false;
       }
   }

   displayCRMAccountPlan(data) {
       const { 
           account_name,
           account_tier,
           total_opportunity_value,
           probability_to_close,
           executive_summary,
           account_overview,
           stakeholder_analysis,
           opportunity_breakdown,
           strategic_initiatives,
           risk_mitigation,
           success_metrics,
           next_30_days,
           mermaid_chart
       } = data;

       if (!account_name) {
           this.elements.accountPlanContainer.innerHTML = `<div class="therapy-card text-center p-8"><p class="text-gray-800 font-bold">Could not generate an account plan from the conversation. Please provide more context.</p></div>`;
           return;
       }

       let html = `
           <div class="crm-header mb-6 animate-fade-in">
               <div class="flex justify-between items-start mb-4">
                   <div>
                       <h1 class="text-3xl font-bold text-gray-900">${account_name}</h1>
                       <div class="flex gap-4 mt-2">
                           <span class="status-badge status-high">${account_tier || 'Strategic'}</span>
                           <span class="text-lg font-semibold text-gray-700">${total_opportunity_value || 'TBD'}</span>
                           <span class="text-lg font-semibold text-green-700">${probability_to_close || 'TBD'}</span>
                       </div>
                   </div>
                   <button onclick="app.copyAccountPlan()" class="bg-customPurple-500 hover:bg-customPurple-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                       Copy Plan
                   </button>
               </div>
               <p class="text-gray-700 text-lg leading-relaxed">${executive_summary || 'No summary available.'}</p>
           </div>

           <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
               <div class="lg:col-span-2">
                   ${account_overview ? `
                   <div class="crm-section mb-4">
                       <h3 class="text-lg font-bold text-gray-900 mb-4">Account Overview</h3>
                       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                           <div>
                               <h4 class="font-semibold text-gray-700 text-sm mb-1">Decision Cycle</h4>
                               <p class="text-gray-600">${account_overview.decision_cycle || 'TBD'}</p>
                           </div>
                           <div>
                               <h4 class="font-semibold text-gray-700 text-sm mb-1">Budget Cycle</h4>
                               <p class="text-gray-600">${account_overview.budget_cycle || 'TBD'}</p>
                           </div>
                           <div>
                               <h4 class="font-semibold text-gray-700 text-sm mb-1">Competitive Landscape</h4>
                               <p class="text-gray-600">${account_overview.competitive_landscape || 'TBD'}</p>
                           </div>
                           <div>
                               <h4 class="font-semibold text-gray-700 text-sm mb-1">Relationship Strength</h4>
                               <p class="text-gray-600">${account_overview.relationship_strength || 'TBD'}</p>
                           </div>
                       </div>
                   </div>
                   ` : ''}

                   ${stakeholder_analysis?.length > 0 ? `
                   <div class="crm-section mb-4">
                       <h3 class="text-lg font-bold text-gray-900 mb-4">Stakeholder Analysis</h3>
                       <div class="overflow-x-auto">
                           <table class="crm-table">
                               <thead>
                                   <tr>
                                       <th>Name/Title</th>
                                       <th>Role</th>
                                       <th>Status</th>
                                       <th>Influence</th>
                                       <th>Next Action</th>
                                   </tr>
                               </thead>
                               <tbody>
                                   ${stakeholder_analysis.map(s => {
                                       const statusClass = s.relationship_status?.toLowerCase() === 'champion' ? 'status-champion' : 
                                                          s.relationship_status?.toLowerCase() === 'blocker' ? 'status-blocker' : 'status-neutral';
                                       const influenceClass = s.influence_level?.toLowerCase() === 'high' ? 'status-high' : 
                                                             s.influence_level?.toLowerCase() === 'medium' ? 'status-medium' : 'status-low';
                                       return `
                                       <tr>
                                           <td class="font-medium">${s.name || 'TBD'}</td>
                                           <td>${s.role || 'TBD'}</td>
                                           <td><span class="status-badge ${statusClass}">${s.relationship_status || 'TBD'}</span></td>
                                           <td><span class="status-badge ${influenceClass}">${s.influence_level || 'TBD'}</span></td>
                                           <td class="text-sm">${s.next_action || 'TBD'}</td>
                                       </tr>`;
                                   }).join('')}
                               </tbody>
                           </table>
                       </div>
                   </div>
                   ` : ''}

                   ${opportunity_breakdown?.length > 0 ? `
                   <div class="crm-section mb-4">
                       <h3 class="text-lg font-bold text-gray-900 mb-4">Opportunity Breakdown</h3>
                       <div class="space-y-4">
                           ${opportunity_breakdown.map(opp => `
                               <div class="border border-gray-200 rounded-lg p-4">
                                   <div class="flex justify-between items-start mb-2">
                                       <h4 class="font-semibold text-gray-900">${opp.opportunity_name || 'Unnamed Opportunity'}</h4>
                                       <div class="text-right">
                                           <div class="font-bold text-customPurple-700">${opp.value || 'TBD'}</div>
                                           <div class="text-sm text-gray-600">${opp.probability || 'TBD'} probability</div>
                                       </div>
                                   </div>
                                   <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                       <div>
                                           <span class="font-medium text-gray-700">Timeline:</span>
                                           <p class="text-gray-600">${opp.timeline || 'TBD'}</p>
                                       </div>
                                       <div>
                                           <span class="font-medium text-gray-700">Stage:</span>
                                           <p class="text-gray-600">${opp.stage || 'TBD'}</p>
                                       </div>
                                       <div>
                                           <span class="font-medium text-gray-700">Position:</span>
                                           <p class="text-gray-600">${opp.competitive_position || 'TBD'}</p>
                                       </div>
                                   </div>
                                   ${opp.key_requirements ? `
                                   <div class="mt-3">
                                       <span class="font-medium text-gray-700">Key Requirements:</span>
                                       <p class="text-gray-600 text-sm">${opp.key_requirements}</p>
                                   </div>
                                   ` : ''}
                               </div>
                           `).join('')}
                       </div>
                   </div>
                   ` : ''}
               </div>

               <div class="lg:col-span-1">
                   ${strategic_initiatives?.length > 0 ? `
                   <div class="crm-section mb-4">
                       <h3 class="text-lg font-bold text-gray-900 mb-4">Strategic Initiatives</h3>
                       <ul class="space-y-3">
                           ${strategic_initiatives.map((initiative, i) => `
                               <li class="flex gap-3">
                                   <span class="flex-shrink-0 w-6 h-6 bg-customPurple-700 text-white rounded-full flex items-center justify-center text-xs font-bold">${i + 1}</span>
                                   <span class="text-gray-700 text-sm">${initiative}</span>
                               </li>
                           `).join('')}
                       </ul>
                   </div>
                   ` : ''}

                   ${risk_mitigation?.length > 0 ? `
                   <div class="crm-section mb-4">
                       <h3 class="text-lg font-bold text-gray-900 mb-4">Risk Mitigation</h3>
                       <div class="space-y-3">
                           ${risk_mitigation.map(risk => {
                               const riskClass = risk.probability?.toLowerCase() === 'high' ? 'status-high' : 
                                               risk.probability?.toLowerCase() === 'medium' ? 'status-medium' : 'status-low';
                               return `
                               <div class="border-l-4 border-red-400 pl-3">
                                   <div class="flex justify-between items-center mb-1">
                                       <h4 class="font-medium text-gray-900 text-sm">${risk.risk || 'Unknown Risk'}</h4>
                                       <span class="status-badge ${riskClass}">${risk.probability || 'TBD'}</span>
                                   </div>
                                   <p class="text-gray-600 text-sm">${risk.mitigation_strategy || 'No mitigation defined'}</p>
                               </div>`;
                           }).join('')}
                       </div>
                   </div>
                   ` : ''}

                   ${success_metrics?.length > 0 ? `
                   <div class="crm-section mb-4">
                       <h3 class="text-lg font-bold text-gray-900 mb-4">Success Metrics</h3>
                       <div class="space-y-3">
                           ${success_metrics.map(metric => `
                               <div class="bg-gray-50 rounded-lg p-3">
                                   <h4 class="font-medium text-gray-900 text-sm">${metric.metric || 'Unknown Metric'}</h4>
                                   <div class="flex justify-between text-sm mt-1">
                                       <span class="text-gray-600">Target: ${metric.target || 'TBD'}</span>
                                       <span class="text-gray-600">${metric.timeline || 'TBD'}</span>
                                   </div>
                                   <p class="text-gray-500 text-xs mt-1">${metric.tracking_method || 'TBD'}</p>
                               </div>
                           `).join('')}
                       </div>
                   </div>
                   ` : ''}

                   ${mermaid_chart ? `
                   <div class="crm-section">
                       <h3 class="text-lg font-bold text-gray-900 mb-4">Stakeholder Map</h3>
                       <div class="mermaid-container">
                           <div class="mermaid-loading flex justify-center items-center absolute inset-0">
                               <div class="loader"></div>
                           </div>
                           <div class="mermaid opacity-0">${mermaid_chart}</div>
                       </div>
                   </div>
                   ` : ''}
               </div>
           </div>

           ${next_30_days?.length > 0 ? `
           <div class="crm-section">
               <h3 class="text-lg font-bold text-gray-900 mb-4">Next 30 Days - Action Items</h3>
               <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                   ${next_30_days.map((action, i) => `
                       <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                           <div class="flex items-center gap-2 mb-2">
                               <span class="w-6 h-6 bg-yellow-400 text-yellow-900 rounded-full flex items-center justify-center text-xs font-bold">${i + 1}</span>
                               <span class="font-medium text-yellow-900">Priority ${i + 1}</span>
                           </div>
                           <p class="text-yellow-800 text-sm">${action}</p>
                       </div>
                   `).join('')}
               </div>
           </div>
           ` : ''}
       `;

       this.elements.accountPlanContainer.innerHTML = html;
       
       if (mermaid_chart) {
           this.renderMermaidChart();
       }
   }
  
   copyAccountPlan() {
       const content = this.elements.accountPlanContainer.innerText;
       
       if (!content || content.trim() === '') {
           this.showTemporaryMessage('Nothing to copy yet!', 'error');
           return;
       }
       
       navigator.clipboard.writeText(content)
           .then(() => {
               this.showTemporaryMessage('Account plan copied! Go forth and conquer! 💪', 'info');
           })
           .catch(() => alert('Copy failed. Try selecting and copying manually.'));
   }

   renderMermaidChart() {
       try {
           setTimeout(async () => {
               const diagrams = document.querySelectorAll('.mermaid:not([data-processed="true"])');

               if (diagrams.length === 0) return;

               await mermaid.run({ nodes: diagrams });

               diagrams.forEach(element => {
                   element.style.opacity = '1';
                   const container = element.closest('.mermaid-container');
                   if (container) {
                       const loader = container.querySelector('.mermaid-loading');
                       if (loader) {
                           loader.style.display = 'none';
                       }
                   }
               });
           }, 300);
       } catch (error) {
           console.error('Mermaid rendering error:', error);
           const containers = document.querySelectorAll('.mermaid-container');
           containers.forEach(container => {
               if (!container.querySelector('[data-processed="true"]')) {
                   container.innerHTML = '<div class="p-6 bg-gray-100 text-gray-700 rounded-xl text-center">Visualization got stage fright. The show must go on without it.</div>';
               }
           });
       }
   }

   share() {
       const shareData = {
           title: 'AskArti - Federal Sales Therapist',
           text: 'When federal sales is breaking you down, Arti builds you back up.',
           url: 'https://askarti.com'
       };
       
       if (navigator.share) {
           navigator.share(shareData).catch(console.error);
       } else {
           navigator.clipboard.writeText(`${shareData.text} ${shareData.url}`)
               .then(() => {
                   this.elements.shareBtn.textContent = 'Link Copied! 📋';
                   setTimeout(() => this.elements.shareBtn.textContent = 'Share the Therapy', 2000);
               })
               .catch(() => alert('Please copy the URL manually: https://askarti.com'));
       }
   }
   
   showTemporaryMessage(message, type = 'info') {
       this.elements.loadingMessageContainer.classList.remove('hidden');
       this.elements.loadingMessage.textContent = message;
       
       // Remove loader for temporary messages
       const loader = this.elements.loadingMessageContainer.querySelector('.loader');
       if (loader) loader.style.display = 'none';
       
       const colorClasses = {
           error: 'text-red-700 font-bold',
           warning: 'text-orange-700 font-bold',
           info: 'text-gray-700 font-medium'
       };
       
       this.elements.loadingMessage.className = colorClasses[type] || colorClasses.info;
       
       setTimeout(() => {
           this.elements.loadingMessageContainer.classList.add('hidden');
           if (loader) loader.style.display = 'block';
       }, 3000);
   }

   showModal() {
       this.elements.aboutModal.classList.remove('hidden');
       requestAnimationFrame(() => {
           this.elements.aboutModal.querySelector('.modal-content').classList.add('show');
       });
   }

   hideModal() {
       const content = this.elements.aboutModal.querySelector('.modal-content');
       content.classList.remove('show');
       setTimeout(() => this.elements.aboutModal.classList.add('hidden'), 200);
   }

   // Method to retry the last message
   retryLastMessage() {
       if (!this.state.lastQuery || this.state.pendingRequest) return;
       
       this.resetSendButton();
       
       // Show we're retrying
       this.addChatMessage(`${this.state.lastQuery} <em class="text-xs text-purple-200">(Let's try this again...)</em>`, true);
       
       this.showTypingIndicator();
       this.showLoadingMessage();
       this.state.pendingRequest = true;
       
       this.makeChatRequest(this.state.lastQuery)
           .then(response => {
               this.hideTypingIndicator();
               this.hideLoadingMessage();
               
               // Check if this is a factual answer
               if (response.response_type === 'factual_answer' && response.answer) {
                   const formattedAnswer = `**Here's what I know:**\n\n${response.answer}`;
                   this.addChatMessage(formattedAnswer, false);
                   this.state.chatHistory.push({ role: 'assistant', content: formattedAnswer });
               } else {
                   this.addChatMessage(response.message || "Got it. Tell me more.", false);
                   this.state.chatHistory.push({ role: 'assistant', content: response.message });
               }
               
               this.state.lastQuery = '';
           })
           .catch(error => {
               console.error('Retry failed:', error);
               this.hideTypingIndicator();
               this.hideLoadingMessage();
               this.addChatMessage("Still having connection issues. Maybe the universe is telling us to take a break?", false);
           })
           .finally(() => {
               this.state.pendingRequest = false;
           });
   }
}

// Initialize the therapy session
const app = new AskArti();

// Add some personality to page visibility changes
document.addEventListener('visibilitychange', () => {
   if (!document.hidden && app.state.messageCount > 0) {
       app.updateGreeting();
   }
});

// Random motivational console messages
const consoleMessages = [
   '%c🎯 Remember: Every "no" is one step closer to "yes"!',
   '%c💪 Federal sales warrior mode: ACTIVATED',
   '%c🚀 Your quota doesn\'t stand a chance',
   '%c☕ Coffee break? You\'ve earned it.',
   '%c🏆 Champions adjust. You\'ve got this!'
];

console.log(
   consoleMessages[Math.floor(Math.random() * consoleMessages.length)],
   'color: #7C6BBE; font-weight: bold; font-size: 14px;'
);
</script>
</body>
</html>